<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘» é¬¼é­‚æ§åˆ¶å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a0033, #2d1b4e, #1a0033);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header {
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 2px solid #ff6b00;
    }

    .header h1 {
      font-size: 28px;
      text-shadow: 0 0 10px #ff6b00, 0 0 20px #ff6b00;
      margin-bottom: 5px;
    }

    .device-id {
      font-size: 14px;
      color: #ffa500;
      opacity: 0.8;
    }

    .status-container {
      padding: 15px;
      text-align: center;
    }

    .status-box {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid #ff6b00;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
    }

    .status-label {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 0 10px currentColor;
    }

    .shake-detector {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .shake-count {
      font-size: 72px;
      font-weight: bold;
      color: #ff6b00;
      text-shadow: 0 0 20px #ff6b00;
      margin: 20px 0;
    }

    .shake-instruction {
      font-size: 18px;
      text-align: center;
      margin: 10px 0;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .control-pad {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      display: none;
    }

    .control-pad.active {
      display: flex;
    }

    .d-pad {
      position: relative;
      width: 280px;
      height: 280px;
    }

    .btn-direction {
      position: absolute;
      width: 80px;
      height: 80px;
      background: linear-gradient(145deg, #ff6b00, #cc5500);
      border: 3px solid #fff;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      transition: all 0.1s;
      user-select: none;
    }

    .btn-direction:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .btn-direction.disabled {
      background: #555;
      opacity: 0.3;
      cursor: not-allowed;
    }

    .btn-up { top: 0; left: 100px; }
    .btn-down { bottom: 0; left: 100px; }
    .btn-left { top: 100px; left: 0; }
    .btn-right { top: 100px; right: 0; }

    .center-status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .light-status {
      font-size: 48px;
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { text-shadow: 0 0 10px currentColor; }
      50% { text-shadow: 0 0 30px currentColor; }
    }

    .light-value {
      font-size: 18px;
      margin-top: 10px;
    }

    .flashlight-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 107, 0, 0.9);
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-10px); }
    }

    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
      box-shadow: 0 0 10px currentColor;
    }

    .connection-status.connected {
      background: #0f0;
    }
  </style>
</head>
<body>
  <div class="connection-status" id="connectionStatus"></div>

  <div class="header">
    <h1>ğŸ‘» é¬¼é­‚æ§åˆ¶å™¨</h1>
    <div class="device-id" id="deviceId">Device-01</div>
  </div>

  <div class="status-container">
    <div class="status-box">
      <div class="status-label">WebSocket ç‹€æ…‹</div>
      <div class="status-value" id="wsStatus">é€£æ¥ä¸­...</div>
    </div>
  </div>

  <!-- æ–å‹•åµæ¸¬å€ -->
  <div class="shake-detector" id="shakeDetector">
    <div class="shake-instruction">ğŸ”¦ è«‹å…ˆç”¨æ‰‹é›»ç­’ç…§äº®å…‰æ•é›»é˜»</div>
    <div class="shake-instruction">ç„¶å¾Œå·¦å³æ–å‹•æ‰‹æ©Ÿ 3 æ¬¡å•Ÿå‹•</div>
    <div class="shake-count" id="shakeCount">0 / 3</div>
    <div class="shake-instruction" style="font-size: 14px;">æ–å‹•é€Ÿåº¦è¶Šå¿«è¶Šå¥½ï¼</div>
  </div>

  <!-- æ–¹å‘æ§åˆ¶å€ -->
  <div class="control-pad" id="controlPad">
    <div class="d-pad">
      <button class="btn-direction btn-up" data-direction="up">â¬†ï¸</button>
      <button class="btn-direction btn-down" data-direction="down">â¬‡ï¸</button>
      <button class="btn-direction btn-left" data-direction="left">â¬…ï¸</button>
      <button class="btn-direction btn-right" data-direction="right">â¡ï¸</button>
      
      <div class="center-status">
        <div class="light-status" id="lightStatus">ğŸŒ‘</div>
        <div class="light-value" id="lightValue">ç­‰å¾…å…‰ç·šæ•¸æ“š...</div>
      </div>
    </div>
  </div>

  <div class="flashlight-hint" id="flashlightHint">
    ğŸ’¡ è¨˜å¾—ç”¨æ‰‹é›»ç­’ç…§äº®å…‰æ•é›»é˜»ï¼
  </div>

  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <script>
    // ========== è¨­å®š ==========
    const WS_URL = 'ws://192.168.100.200:8080';
    
    // å¾ URL åƒæ•¸å–å¾— device IDï¼Œé è¨­ç‚º device-01
    const urlParams = new URLSearchParams(window.location.search);
    const DEVICE_NUMBER = urlParams.get('device') || '01';
    const DEVICE_ID = `esp32-device-${DEVICE_NUMBER}`;
    
    // å…‰ç·šé–¾å€¼ï¼ˆéœ€è¦èˆ‡ ESP32 ä¸€è‡´ï¼‰
    const LIGHT_THRESHOLD = 3000;
    
    // ========== ç‹€æ…‹ ==========
    let ws = null;
    let isActivated = false;  // æ˜¯å¦å·²å•Ÿå‹•ï¼ˆæ–å‹•3æ¬¡ï¼‰
    let shakeCount = 0;
    let lastShakeTime = 0;
    let currentLight = 0;
    let isLightActive = false;
    
    // ========== DOM å…ƒç´  ==========
    const deviceIdEl = document.getElementById('deviceId');
    const wsStatusEl = document.getElementById('wsStatus');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const shakeDetectorEl = document.getElementById('shakeDetector');
    const shakeCountEl = document.getElementById('shakeCount');
    const controlPadEl = document.getElementById('controlPad');
    const lightStatusEl = document.getElementById('lightStatus');
    const lightValueEl = document.getElementById('lightValue');
    const flashlightHintEl = document.getElementById('flashlightHint');
    
    // ========== åˆå§‹åŒ– ==========
    deviceIdEl.textContent = DEVICE_ID.toUpperCase();
    
    // ========== WebSocket é€£æ¥ ==========
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('âœ… WebSocket é€£æ¥æˆåŠŸ');
        wsStatusEl.textContent = 'å·²é€£æ¥';
        wsStatusEl.style.color = '#0f0';
        connectionStatusEl.classList.add('connected');
        
        // è¨‚é–±å…‰ç·šæ•¸æ“š
        subscribeLightData();
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error('è§£æè¨Šæ¯å¤±æ•—:', e);
        }
      };
      
      ws.onerror = (error) => {
        console.error('âŒ WebSocket éŒ¯èª¤:', error);
        wsStatusEl.textContent = 'é€£æ¥éŒ¯èª¤';
        wsStatusEl.style.color = '#f00';
      };
      
      ws.onclose = () => {
        console.log('ğŸ”Œ WebSocket å·²æ–·é–‹ï¼Œ3 ç§’å¾Œé‡é€£...');
        wsStatusEl.textContent = 'å·²æ–·é–‹';
        wsStatusEl.style.color = '#f00';
        connectionStatusEl.classList.remove('connected');
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // è¨‚é–±å…‰ç·šæ•¸æ“š
    function subscribeLightData() {
      const subscribeMsg = {
        type: 'subscribe',
        topic: `esp32/${DEVICE_ID}/light`
      };
      ws.send(JSON.stringify(subscribeMsg));
      console.log(`ğŸ“¡ è¨‚é–±ä¸»é¡Œ: esp32/${DEVICE_ID}/light`);
    }
    
    // è™•ç†æ¥æ”¶åˆ°çš„è¨Šæ¯
    function handleMessage(data) {
      if (data.topic && data.topic.includes('/light')) {
        // å…‰ç·šæ•¸æ“š
        const payload = JSON.parse(data.payload);
        currentLight = payload.light;
        isLightActive = payload.active;
        
        updateLightDisplay();
      }
    }
    
    // æ›´æ–°å…‰ç·šé¡¯ç¤º
    function updateLightDisplay() {
      lightValueEl.textContent = `å…‰ç·š: ${currentLight}`;
      
      if (isLightActive) {
        lightStatusEl.textContent = 'ğŸ‘»';
        lightStatusEl.style.color = '#ffa500';
        flashlightHintEl.style.display = 'none';
      } else {
        lightStatusEl.textContent = 'ğŸŒ‘';
        lightStatusEl.style.color = '#666';
        flashlightHintEl.style.display = 'block';
      }
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      updateButtonStates();
    }
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼ˆå…‰ç·šä¸è¶³æ™‚ç¦ç”¨ï¼‰
    function updateButtonStates() {
      const buttons = document.querySelectorAll('.btn-direction');
      buttons.forEach(btn => {
        if (isActivated && isLightActive) {
          btn.classList.remove('disabled');
        } else {
          btn.classList.add('disabled');
        }
      });
    }
    
    // ========== æ–å‹•åµæ¸¬ ==========
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', handleMotion);
    }
    
    function handleMotion(event) {
      if (isActivated) return;  // å·²å•Ÿå‹•å°±ä¸å†åµæ¸¬
      
      const acc = event.accelerationIncludingGravity;
      const x = acc.x;
      const y = acc.y;
      const z = acc.z;
      
      // è¨ˆç®—åŠ é€Ÿåº¦ç¸½é‡
      const magnitude = Math.sqrt(x*x + y*y + z*z);
      
      // åµæ¸¬å·¦å³æ–å‹•ï¼ˆX è»¸è®ŠåŒ–å¤§ï¼‰
      const now = Date.now();
      if (Math.abs(x) > 15 && now - lastShakeTime > 300) {
        lastShakeTime = now;
        shakeCount++;
        shakeCountEl.textContent = `${shakeCount} / 3`;
        
        // éœ‡å‹•å›é¥‹
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
        
        if (shakeCount >= 3) {
          activateController();
        }
      }
    }
    
    // å•Ÿå‹•æ§åˆ¶å™¨
    function activateController() {
      isActivated = true;
      shakeDetectorEl.style.display = 'none';
      controlPadEl.classList.add('active');
      
      console.log('ğŸ® æ§åˆ¶å™¨å·²å•Ÿå‹•ï¼');
      
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
    }
    
    // ========== æ–¹å‘æ§åˆ¶ ==========
    document.querySelectorAll('.btn-direction').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!isActivated || !isLightActive) {
          console.log('âŒ ç„¡æ³•ç§»å‹•ï¼šæœªå•Ÿå‹•æˆ–å…‰ç·šä¸è¶³');
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          return;
        }
        
        const direction = btn.dataset.direction;
        sendMove(direction);
        
        // éœ‡å‹•å›é¥‹
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      });
    });
    
    // ç™¼é€ç§»å‹•æŒ‡ä»¤
    function sendMove(direction) {
      const message = {
        type: 'publish',
        topic: `ghost/move/${DEVICE_ID}`,
        payload: JSON.stringify({
          device: DEVICE_ID,
          direction: direction,
          timestamp: Date.now()
        })
      };
      
      ws.send(JSON.stringify(message));
      console.log(`ğŸ® ç§»å‹•: ${direction}`);
    }
    
    // ========== å•Ÿå‹• ==========
    connectWebSocket();
    
    // è«‹æ±‚å‹•ä½œæ„Ÿæ¸¬å™¨æ¬Šé™ï¼ˆiOS 13+ï¼‰
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            console.log('âœ… å‹•ä½œæ„Ÿæ¸¬å™¨æ¬Šé™å·²æˆäºˆ');
          }
        })
        .catch(console.error);
    }
  </script>
</body>
</html>
