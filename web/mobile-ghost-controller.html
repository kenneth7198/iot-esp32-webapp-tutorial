<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>👻 鬼魂控制器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a0033, #2d1b4e, #1a0033);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header {
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 2px solid #ff6b00;
    }

    .header h1 {
      font-size: 28px;
      text-shadow: 0 0 10px #ff6b00, 0 0 20px #ff6b00;
      margin-bottom: 5px;
    }

    .device-id {
      font-size: 14px;
      color: #ffa500;
      opacity: 0.8;
    }

    .back-button {
      position: absolute;
      top: 20px;
      left: 15px;
      background: rgba(255, 107, 0, 0.2);
      border: 2px solid #ff6b00;
      border-radius: 10px;
      padding: 8px 15px;
      color: #ffa500;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .back-button:hover,
    .back-button:active {
      background: rgba(255, 107, 0, 0.4);
      transform: scale(1.05);
    }

    .status-container {
      padding: 15px;
      text-align: center;
    }

    .status-box {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid #ff6b00;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
    }

    .status-label {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 0 10px currentColor;
    }

    .light-info-top {
      position: fixed;
      top: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ff6b00;
      border-radius: 15px;
      padding: 15px 25px;
      text-align: center;
      z-index: 100;
      min-width: 200px;
    }

    .light-value-top {
      font-size: 18px;
      color: #ffaa00;
      font-weight: bold;
    }

    .instruction-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #ff6b00;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      z-index: 1000;
      max-width: 80%;
      box-shadow: 0 0 30px rgba(255, 107, 0, 0.5);
      display: none;
    }

    .instruction-message.show {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .instruction-icon {
      font-size: 64px;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .instruction-text {
      font-size: 18px;
      line-height: 1.8;
      color: #ffaa00;
    }

    .control-pad {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .d-pad {
      position: relative;
      width: 280px;
      height: 280px;
    }

    .btn-direction {
      position: absolute;
      width: 80px;
      height: 80px;
      background: linear-gradient(145deg, #ff6b00, #cc5500);
      border: 3px solid #fff;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      transition: all 0.1s;
      user-select: none;
    }

    .btn-direction:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .btn-direction.disabled {
      background: #555;
      opacity: 0.3;
      cursor: not-allowed;
    }

    .btn-up { top: 0; left: 100px; }
    .btn-down { bottom: 0; left: 100px; }
    .btn-left { top: 100px; left: 0; }
    .btn-right { top: 100px; right: 0; }

    .btn-grab {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: linear-gradient(145deg, #ffd700, #ffaa00);
      border: 4px solid #fff;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.7);
      transition: all 0.1s;
      user-select: none;
    }

    .btn-grab:active {
      transform: translate(-50%, -50%) scale(0.9);
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.7);
    }

    .btn-grab.disabled {
      background: #555;
      opacity: 0.3;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-grab-text {
      font-size: 12px;
      margin-top: 5px;
      color: #000;
      font-weight: bold;
    }

    @keyframes glow {
      0%, 100% { text-shadow: 0 0 10px currentColor; }
      50% { text-shadow: 0 0 30px currentColor; }
    }

    .flashlight-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 107, 0, 0.9);
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-10px); }
    }

    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
      box-shadow: 0 0 10px currentColor;
    }

    .connection-status.connected {
      background: #0f0;
    }
  </style>
</head>
<body>
  <a href="ghost-controller-select.html" class="back-button">
    <span>◀</span>
    <span>返回</span>
  </a>

  <div class="connection-status" id="connectionStatus"></div>

  <div class="header">
    <h1>👻 鬼魂控制器</h1>
    <div class="device-id" id="deviceId">Device-01</div>
  </div>

  <div class="status-container">
    <div class="status-box">
      <div class="status-label">WebSocket 狀態</div>
      <div class="status-value" id="wsStatus">連接中...</div>
    </div>
  </div>

  <!-- 光線資訊顯示在上方 -->
  <div class="light-info-top">
    <div class="light-value-top" id="lightValue">光線：等待數據...</div>
  </div>

  <!-- 提示訊息 -->
  <div class="instruction-message" id="instructionMessage">
    <div class="instruction-icon">🔦</div>
    <div class="instruction-text">
      請用手電筒照亮 ESP32 的光敏電阻<br>
      光線充足後即可開始控制鬼魂
    </div>
  </div>

  <!-- 方向控制區 -->
  <div class="control-pad active" id="controlPad">
    <div class="d-pad">
      <button class="btn-direction btn-up" data-direction="up">⬆️</button>
      <button class="btn-direction btn-down" data-direction="down">⬇️</button>
      <button class="btn-direction btn-left" data-direction="left">⬅️</button>
      <button class="btn-direction btn-right" data-direction="right">➡️</button>
      
      <!-- 中間只保留抓取按鈕 -->
      <button class="btn-grab" id="btnGrab">
        <span>💎</span>
        <span class="btn-grab-text">抓取</span>
      </button>
    </div>
  </div>

  <div class="flashlight-hint" id="flashlightHint">
    💡 記得用手電筒照亮光敏電阻！
  </div>

  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <script>
    // ========== 設定 ==========
    const WS_URL = 'ws://192.168.100.200:8080';
    
    // 從 sessionStorage 或 URL 參數取得 device ID，預設為 device-01
    let DEVICE_NUMBER = sessionStorage.getItem('selectedDevice');
    if (!DEVICE_NUMBER) {
      // 如果 sessionStorage 沒有，嘗試從 URL 參數讀取
      const urlParams = new URLSearchParams(window.location.search);
      DEVICE_NUMBER = urlParams.get('device') || '01';
      // 儲存到 sessionStorage 供下次使用
      sessionStorage.setItem('selectedDevice', DEVICE_NUMBER);
    }
    const DEVICE_ID = `esp32-device-${DEVICE_NUMBER}`;
    
    // 光線閾值（需要與 ESP32 一致）
    const LIGHT_THRESHOLD = 3000;
    
    // ========== 狀態 ==========
    let ws = null;
    let currentLight = 0;
    let isLightActive = false;
    
    // ========== DOM 元素 ==========
    const deviceIdEl = document.getElementById('deviceId');
    const wsStatusEl = document.getElementById('wsStatus');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const instructionMessageEl = document.getElementById('instructionMessage');
    const controlPadEl = document.getElementById('controlPad');
    const lightStatusEl = document.getElementById('lightStatus');
    const lightValueEl = document.getElementById('lightValue');
    const flashlightHintEl = document.getElementById('flashlightHint');
    
    // ========== 初始化 ==========
    deviceIdEl.textContent = DEVICE_ID.toUpperCase();
    
    // ========== WebSocket 連接 ==========
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('✅ WebSocket 連接成功');
        wsStatusEl.textContent = '已連接';
        wsStatusEl.style.color = '#0f0';
        connectionStatusEl.classList.add('connected');
        
        // 訂閱光線數據
        subscribeLightData();
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error('解析訊息失敗:', e);
        }
      };
      
      ws.onerror = (error) => {
        console.error('❌ WebSocket 錯誤:', error);
        wsStatusEl.textContent = '連接錯誤';
        wsStatusEl.style.color = '#f00';
      };
      
      ws.onclose = () => {
        console.log('🔌 WebSocket 已斷開，3 秒後重連...');
        wsStatusEl.textContent = '已斷開';
        wsStatusEl.style.color = '#f00';
        connectionStatusEl.classList.remove('connected');
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // 訂閱光線數據
    function subscribeLightData() {
      const subscribeMsg = {
        type: 'subscribe',
        topic: `esp32/${DEVICE_ID}/light`
      };
      ws.send(JSON.stringify(subscribeMsg));
      console.log(`📡 訂閱主題: esp32/${DEVICE_ID}/light`);
    }
    
    // 處理接收到的訊息
    function handleMessage(data) {
      if (data.topic && data.topic.includes('/light')) {
        // 檢查是否是自己設備的光線數據
        const expectedTopic = `esp32/${DEVICE_ID}/light`;
        if (data.topic !== expectedTopic) {
          console.log(`🚫 忽略其他設備數據: ${data.topic}`);
          return; // 忽略其他設備的光線數據
        }
        
        // 處理自己設備的光線數據
        const payload = JSON.parse(data.payload);
        currentLight = payload.light;
        isLightActive = payload.active;
        
        console.log(`💡 ${DEVICE_ID} 光線值: ${currentLight} (active: ${isLightActive})`);
        updateLightDisplay();
      }
    }
    
    // 更新光線顯示
    function updateLightDisplay() {
      lightValueEl.textContent = `光線：${currentLight}`;
      
      if (isLightActive) {
        lightValueEl.style.color = '#0f0';
        flashlightHintEl.style.display = 'none';
      } else {
        lightValueEl.style.color = '#ffaa00';
        flashlightHintEl.style.display = 'block';
      }
      
      // 更新按鈕狀態
      updateButtonStates();
    }
    
    // 更新按鈕狀態（光線不足時禁用）
    function updateButtonStates() {
      const buttons = document.querySelectorAll('.btn-direction');
      const grabButton = document.getElementById('btnGrab');
      
      buttons.forEach(btn => {
        if (isLightActive) {
          btn.classList.remove('disabled');
        } else {
          btn.classList.add('disabled');
        }
      });
      
      // 抓取按鈕也需要光線激活
      if (grabButton) {
        if (isLightActive) {
          grabButton.classList.remove('disabled');
        } else {
          grabButton.classList.add('disabled');
        }
      }
      
      // 同時更新指示訊息顯示
      updateInstructionDisplay();
    }
    
    // ========== 指示訊息顯示 ==========
    function updateInstructionDisplay() {
      if (isLightActive) {
        instructionMessageEl.style.display = 'none';
      } else {
        instructionMessageEl.style.display = 'block';
      }
    }
    
    // ========== 方向控制 ==========
    document.querySelectorAll('.btn-direction').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!isLightActive) {
          console.log('❌ 無法移動：光線不足');
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          return;
        }
        
        const direction = btn.dataset.direction;
        sendMove(direction);
        
        // 震動回饋
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      });
    });
    
    // 發送移動指令
    function sendMove(direction) {
      const message = {
        type: 'publish',
        topic: `ghost/move/${DEVICE_ID}`,
        payload: JSON.stringify({
          device: DEVICE_ID,
          direction: direction,
          timestamp: Date.now()
        })
      };
      
      ws.send(JSON.stringify(message));
      console.log(`🎮 移動: ${direction}`);
    }

    // ========== 抓取寶物控制 ==========
    document.getElementById('btnGrab').addEventListener('click', () => {
      if (!isLightActive) {
        console.log('❌ 無法抓取：光線不足');
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        return;
      }
      
      sendGrab();
      
      // 震動回饋
      if (navigator.vibrate) {
        navigator.vibrate([50, 50, 50]); // 三次短震動
      }
    });

    // 發送抓取指令
    function sendGrab() {
      const message = {
        type: 'publish',
        topic: `ghost/grab/${DEVICE_ID}`,
        payload: JSON.stringify({
          device: DEVICE_ID,
          timestamp: Date.now()
        })
      };
      
      ws.send(JSON.stringify(message));
      console.log(`💎 嘗試抓取寶物`);
    }
    
    // ========== 啟動 ==========
    connectWebSocket();
    
    // 請求動作感測器權限（iOS 13+）
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            console.log('✅ 動作感測器權限已授予');
          }
        })
        .catch(console.error);
    }
  </script>
</body>
</html>
