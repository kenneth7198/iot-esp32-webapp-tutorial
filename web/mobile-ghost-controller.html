<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ‘» é¬¼é­‚æ§åˆ¶å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a0033, #2d1b4e, #1a0033);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header {
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 2px solid #ff6b00;
    }

    .header h1 {
      font-size: 28px;
      text-shadow: 0 0 10px #ff6b00, 0 0 20px #ff6b00;
      margin-bottom: 5px;
    }

    .device-id {
      font-size: 14px;
      color: #ffa500;
      opacity: 0.8;
    }

    .back-button {
      position: absolute;
      top: 20px;
      left: 15px;
      background: rgba(255, 107, 0, 0.2);
      border: 2px solid #ff6b00;
      border-radius: 10px;
      padding: 8px 15px;
      color: #ffa500;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .back-button:hover,
    .back-button:active {
      background: rgba(255, 107, 0, 0.4);
      transform: scale(1.05);
    }

    .status-container {
      padding: 15px;
      text-align: center;
    }

    .status-box {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid #ff6b00;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
    }

    .status-label {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 0 10px currentColor;
    }

    .light-info-top {
      position: fixed;
      top: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ff6b00;
      border-radius: 15px;
      padding: 15px 25px;
      text-align: center;
      z-index: 100;
      min-width: 200px;
    }

    .light-value-top {
      font-size: 18px;
      color: #ffaa00;
      font-weight: bold;
    }

    .instruction-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #ff6b00;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      z-index: 1000;
      max-width: 80%;
      box-shadow: 0 0 30px rgba(255, 107, 0, 0.5);
      display: none;
    }

    .instruction-message.show {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .instruction-icon {
      font-size: 64px;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .instruction-text {
      font-size: 18px;
      line-height: 1.8;
      color: #ffaa00;
    }

    .control-pad {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .d-pad {
      position: relative;
      width: 280px;
      height: 280px;
    }

    .btn-direction {
      position: absolute;
      width: 80px;
      height: 80px;
      background: linear-gradient(145deg, #ff6b00, #cc5500);
      border: 3px solid #fff;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      transition: all 0.1s;
      user-select: none;
    }

    .btn-direction:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .btn-direction.disabled {
      background: #555;
      opacity: 0.3;
      cursor: not-allowed;
    }

    .btn-up { top: 0; left: 100px; }
    .btn-down { bottom: 0; left: 100px; }
    .btn-left { top: 100px; left: 0; }
    .btn-right { top: 100px; right: 0; }

    .btn-grab {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: linear-gradient(145deg, #ffd700, #ffaa00);
      border: 4px solid #fff;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.7);
      transition: all 0.1s;
      user-select: none;
    }

    .btn-grab:active {
      transform: translate(-50%, -50%) scale(0.9);
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.7);
    }

    .btn-grab.disabled {
      background: #555;
      opacity: 0.3;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-grab-text {
      font-size: 12px;
      margin-top: 5px;
      color: #000;
      font-weight: bold;
    }

    @keyframes glow {
      0%, 100% { text-shadow: 0 0 10px currentColor; }
      50% { text-shadow: 0 0 30px currentColor; }
    }

    .flashlight-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 107, 0, 0.9);
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-10px); }
    }

    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
      box-shadow: 0 0 10px currentColor;
    }

    .connection-status.connected {
      background: #0f0;
    }
  </style>
</head>
<body>
  <a href="ghost-controller-select.html" class="back-button">
    <span>â—€</span>
    <span>è¿”å›</span>
  </a>

  <div class="connection-status" id="connectionStatus"></div>

  <div class="header">
    <h1>ğŸ‘» é¬¼é­‚æ§åˆ¶å™¨</h1>
    <div class="device-id" id="deviceId">Device-01</div>
  </div>

  <div class="status-container">
    <div class="status-box">
      <div class="status-label">WebSocket ç‹€æ…‹</div>
      <div class="status-value" id="wsStatus">é€£æ¥ä¸­...</div>
    </div>
  </div>

  <!-- å…‰ç·šè³‡è¨Šé¡¯ç¤ºåœ¨ä¸Šæ–¹ -->
  <div class="light-info-top">
    <div class="light-value-top" id="lightValue">å…‰ç·šï¼šç­‰å¾…æ•¸æ“š...</div>
  </div>

  <!-- æç¤ºè¨Šæ¯ -->
  <div class="instruction-message" id="instructionMessage">
    <div class="instruction-icon">ğŸ”¦</div>
    <div class="instruction-text">
      è«‹ç”¨æ‰‹é›»ç­’ç…§äº® ESP32 çš„å…‰æ•é›»é˜»<br>
      å…‰ç·šå……è¶³å¾Œå³å¯é–‹å§‹æ§åˆ¶é¬¼é­‚
    </div>
  </div>

  <!-- æ–¹å‘æ§åˆ¶å€ -->
  <div class="control-pad active" id="controlPad">
    <div class="d-pad">
      <button class="btn-direction btn-up" data-direction="up">â¬†ï¸</button>
      <button class="btn-direction btn-down" data-direction="down">â¬‡ï¸</button>
      <button class="btn-direction btn-left" data-direction="left">â¬…ï¸</button>
      <button class="btn-direction btn-right" data-direction="right">â¡ï¸</button>
      
      <!-- ä¸­é–“åªä¿ç•™æŠ“å–æŒ‰éˆ• -->
      <button class="btn-grab" id="btnGrab">
        <span>ğŸ’</span>
        <span class="btn-grab-text">æŠ“å–</span>
      </button>
    </div>
  </div>

  <div class="flashlight-hint" id="flashlightHint">
    ğŸ’¡ è¨˜å¾—ç”¨æ‰‹é›»ç­’ç…§äº®å…‰æ•é›»é˜»ï¼
  </div>

  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <script>
    // ========== è¨­å®š ==========
    const WS_URL = 'ws://192.168.100.200:8080';
    
    // å¾ sessionStorage æˆ– URL åƒæ•¸å–å¾— device IDï¼Œé è¨­ç‚º device-01
    let DEVICE_NUMBER = sessionStorage.getItem('selectedDevice');
    if (!DEVICE_NUMBER) {
      // å¦‚æœ sessionStorage æ²’æœ‰ï¼Œå˜—è©¦å¾ URL åƒæ•¸è®€å–
      const urlParams = new URLSearchParams(window.location.search);
      DEVICE_NUMBER = urlParams.get('device') || '01';
      // å„²å­˜åˆ° sessionStorage ä¾›ä¸‹æ¬¡ä½¿ç”¨
      sessionStorage.setItem('selectedDevice', DEVICE_NUMBER);
    }
    const DEVICE_ID = `esp32-device-${DEVICE_NUMBER}`;
    
    // å…‰ç·šé–¾å€¼ï¼ˆéœ€è¦èˆ‡ ESP32 ä¸€è‡´ï¼‰
    const LIGHT_THRESHOLD = 3000;
    
    // ========== ç‹€æ…‹ ==========
    let ws = null;
    let currentLight = 0;
    let isLightActive = false;
    
    // ========== DOM å…ƒç´  ==========
    const deviceIdEl = document.getElementById('deviceId');
    const wsStatusEl = document.getElementById('wsStatus');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const instructionMessageEl = document.getElementById('instructionMessage');
    const controlPadEl = document.getElementById('controlPad');
    const lightStatusEl = document.getElementById('lightStatus');
    const lightValueEl = document.getElementById('lightValue');
    const flashlightHintEl = document.getElementById('flashlightHint');
    
    // ========== åˆå§‹åŒ– ==========
    deviceIdEl.textContent = DEVICE_ID.toUpperCase();
    
    // ========== WebSocket é€£æ¥ ==========
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('âœ… WebSocket é€£æ¥æˆåŠŸ');
        wsStatusEl.textContent = 'å·²é€£æ¥';
        wsStatusEl.style.color = '#0f0';
        connectionStatusEl.classList.add('connected');
        
        // è¨‚é–±å…‰ç·šæ•¸æ“š
        subscribeLightData();
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error('è§£æè¨Šæ¯å¤±æ•—:', e);
        }
      };
      
      ws.onerror = (error) => {
        console.error('âŒ WebSocket éŒ¯èª¤:', error);
        wsStatusEl.textContent = 'é€£æ¥éŒ¯èª¤';
        wsStatusEl.style.color = '#f00';
      };
      
      ws.onclose = () => {
        console.log('ğŸ”Œ WebSocket å·²æ–·é–‹ï¼Œ3 ç§’å¾Œé‡é€£...');
        wsStatusEl.textContent = 'å·²æ–·é–‹';
        wsStatusEl.style.color = '#f00';
        connectionStatusEl.classList.remove('connected');
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // è¨‚é–±å…‰ç·šæ•¸æ“š
    function subscribeLightData() {
      const subscribeMsg = {
        type: 'subscribe',
        topic: `esp32/${DEVICE_ID}/light`
      };
      ws.send(JSON.stringify(subscribeMsg));
      console.log(`ğŸ“¡ è¨‚é–±ä¸»é¡Œ: esp32/${DEVICE_ID}/light`);
    }
    
    // è™•ç†æ¥æ”¶åˆ°çš„è¨Šæ¯
    function handleMessage(data) {
      if (data.topic && data.topic.includes('/light')) {
        // æª¢æŸ¥æ˜¯å¦æ˜¯è‡ªå·±è¨­å‚™çš„å…‰ç·šæ•¸æ“š
        const expectedTopic = `esp32/${DEVICE_ID}/light`;
        if (data.topic !== expectedTopic) {
          console.log(`ğŸš« å¿½ç•¥å…¶ä»–è¨­å‚™æ•¸æ“š: ${data.topic}`);
          return; // å¿½ç•¥å…¶ä»–è¨­å‚™çš„å…‰ç·šæ•¸æ“š
        }
        
        // è™•ç†è‡ªå·±è¨­å‚™çš„å…‰ç·šæ•¸æ“š
        const payload = JSON.parse(data.payload);
        currentLight = payload.light;
        isLightActive = payload.active;
        
        console.log(`ğŸ’¡ ${DEVICE_ID} å…‰ç·šå€¼: ${currentLight} (active: ${isLightActive})`);
        updateLightDisplay();
      }
    }
    
    // æ›´æ–°å…‰ç·šé¡¯ç¤º
    function updateLightDisplay() {
      lightValueEl.textContent = `å…‰ç·šï¼š${currentLight}`;
      
      if (isLightActive) {
        lightValueEl.style.color = '#0f0';
        flashlightHintEl.style.display = 'none';
      } else {
        lightValueEl.style.color = '#ffaa00';
        flashlightHintEl.style.display = 'block';
      }
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      updateButtonStates();
    }
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼ˆå…‰ç·šä¸è¶³æ™‚ç¦ç”¨ï¼‰
    function updateButtonStates() {
      const buttons = document.querySelectorAll('.btn-direction');
      const grabButton = document.getElementById('btnGrab');
      
      buttons.forEach(btn => {
        if (isLightActive) {
          btn.classList.remove('disabled');
        } else {
          btn.classList.add('disabled');
        }
      });
      
      // æŠ“å–æŒ‰éˆ•ä¹Ÿéœ€è¦å…‰ç·šæ¿€æ´»
      if (grabButton) {
        if (isLightActive) {
          grabButton.classList.remove('disabled');
        } else {
          grabButton.classList.add('disabled');
        }
      }
      
      // åŒæ™‚æ›´æ–°æŒ‡ç¤ºè¨Šæ¯é¡¯ç¤º
      updateInstructionDisplay();
    }
    
    // ========== æŒ‡ç¤ºè¨Šæ¯é¡¯ç¤º ==========
    function updateInstructionDisplay() {
      if (isLightActive) {
        instructionMessageEl.style.display = 'none';
      } else {
        instructionMessageEl.style.display = 'block';
      }
    }
    
    // ========== æ–¹å‘æ§åˆ¶ ==========
    document.querySelectorAll('.btn-direction').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!isLightActive) {
          console.log('âŒ ç„¡æ³•ç§»å‹•ï¼šå…‰ç·šä¸è¶³');
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          return;
        }
        
        const direction = btn.dataset.direction;
        sendMove(direction);
        
        // éœ‡å‹•å›é¥‹
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      });
    });
    
    // ç™¼é€ç§»å‹•æŒ‡ä»¤
    function sendMove(direction) {
      const message = {
        type: 'publish',
        topic: `ghost/move/${DEVICE_ID}`,
        payload: JSON.stringify({
          device: DEVICE_ID,
          direction: direction,
          timestamp: Date.now()
        })
      };
      
      ws.send(JSON.stringify(message));
      console.log(`ğŸ® ç§»å‹•: ${direction}`);
    }

    // ========== æŠ“å–å¯¶ç‰©æ§åˆ¶ ==========
    document.getElementById('btnGrab').addEventListener('click', () => {
      if (!isLightActive) {
        console.log('âŒ ç„¡æ³•æŠ“å–ï¼šå…‰ç·šä¸è¶³');
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        return;
      }
      
      sendGrab();
      
      // éœ‡å‹•å›é¥‹
      if (navigator.vibrate) {
        navigator.vibrate([50, 50, 50]); // ä¸‰æ¬¡çŸ­éœ‡å‹•
      }
    });

    // ç™¼é€æŠ“å–æŒ‡ä»¤
    function sendGrab() {
      const message = {
        type: 'publish',
        topic: `ghost/grab/${DEVICE_ID}`,
        payload: JSON.stringify({
          device: DEVICE_ID,
          timestamp: Date.now()
        })
      };
      
      ws.send(JSON.stringify(message));
      console.log(`ğŸ’ å˜—è©¦æŠ“å–å¯¶ç‰©`);
    }
    
    // ========== å•Ÿå‹• ==========
    connectWebSocket();
    
    // è«‹æ±‚å‹•ä½œæ„Ÿæ¸¬å™¨æ¬Šé™ï¼ˆiOS 13+ï¼‰
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            console.log('âœ… å‹•ä½œæ„Ÿæ¸¬å™¨æ¬Šé™å·²æˆäºˆ');
          }
        })
        .catch(console.error);
    }
  </script>
</body>
</html>
