<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 å¤šè¨­å‚™è§¸æ‘¸ç›£æ§</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .device-card {
      border: 2px solid #dee2e6;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    .device-card.touched {
      border-color: #fbbf24;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
    .device-card.released {
      border-color: #6b7280;
      background: #f9fafb;
    }
    .status-indicator {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-block;
      transition: all 0.3s ease;
    }
    .status-touched {
      background: #fbbf24;
      box-shadow: 0 0 15px #fbbf24;
    }
    .status-released {
      background: #6b7280;
    }
    .log {
      height: 300px;
      overflow: auto;
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.85rem;
    }
    .group-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container mt-3">
    <h2 class="text-center mb-4">
      <i class="fas fa-microchip"></i> ESP32 å¤šè¨­å‚™è§¸æ‘¸ç›£æ§
    </h2>

    <!-- é€£ç·šè¨­å®š -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-plug"></i> MQTT é€£ç·šè¨­å®š</h5>
        <div class="row">
          <div class="col-md-8">
            <input type="text" id="mqttUrl" class="form-control" 
                   value="ws://192.168.100.200:9001" 
                   placeholder="ws://192.168.100.200:9001">
            <small class="text-muted">Mosquitto WebSocket URL</small>
          </div>
          <div class="col-md-4">
            <button id="btnConnect" class="btn btn-primary w-100">
              <i class="fas fa-link"></i> é€£ç·š
            </button>
          </div>
        </div>
        <div class="mt-2">
          <span id="connectionStatus" class="badge bg-secondary">æœªé€£ç·š</span>
        </div>
      </div>
    </div>

    <!-- è¨­å‚™é¡¯ç¤ºå€ -->
    <div id="devicesContainer"></div>

    <!-- è¨Šæ¯æ—¥èªŒ -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-terminal"></i> è¨Šæ¯æ—¥èªŒ</h5>
        <div class="log" id="logContainer"></div>
        <button class="btn btn-sm btn-outline-secondary mt-2" id="btnClearLog">
          <i class="fas fa-trash"></i> æ¸…é™¤æ—¥èªŒ
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    let mqttClient = null;
    const devices = new Map();  // å„²å­˜æ‰€æœ‰è¨­å‚™ç‹€æ…‹

    // æ—¥èªŒå‡½å¼
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
      const colors = {
        info: '#10b981',
        success: '#22c55e',
        error: '#ef4444',
        touch: '#fbbf24',
        release: '#6b7280'
      };
      
      const logEntry = document.createElement('div');
      logEntry.style.color = colors[type] || colors.info;
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      document.getElementById('logContainer').appendChild(logEntry);
      document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
    }

    // æ›´æ–°é€£ç·šç‹€æ…‹
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (connected) {
        statusEl.className = 'badge bg-success';
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> å·²é€£ç·š';
      } else {
        statusEl.className = 'badge bg-secondary';
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i> æœªé€£ç·š';
      }
    }

    // æ›´æ–°æˆ–å»ºç«‹è¨­å‚™å¡ç‰‡
    function updateDeviceCard(deviceId, touchState, timestamp) {
      let card = document.getElementById(`device-${deviceId}`);
      
      if (!card) {
        // å»ºç«‹æ–°çš„è¨­å‚™å¡ç‰‡
        const groupName = deviceId.split('-')[1];  // å¾ esp32-group1-01 å–å¾— group1
        let groupSection = document.getElementById(`group-${groupName}`);
        
        if (!groupSection) {
          // å»ºç«‹ç¾¤çµ„å€åŸŸ
          const container = document.getElementById('devicesContainer');
          groupSection = document.createElement('div');
          groupSection.id = `group-${groupName}`;
          groupSection.className = 'group-section';
          groupSection.innerHTML = `
            <h5><i class="fas fa-layer-group"></i> ${groupName.toUpperCase()}</h5>
            <div class="row" id="group-${groupName}-devices"></div>
          `;
          container.appendChild(groupSection);
        }
        
        // å»ºç«‹è¨­å‚™å¡ç‰‡
        const devicesRow = document.getElementById(`group-${groupName}-devices`);
        const cardCol = document.createElement('div');
        cardCol.className = 'col-md-4 col-sm-6';
        cardCol.innerHTML = `
          <div class="device-card released" id="device-${deviceId}">
            <div class="d-flex align-items-center mb-2">
              <span class="status-indicator status-released me-2" id="indicator-${deviceId}"></span>
              <strong>${deviceId}</strong>
            </div>
            <div class="text-muted small">
              ç‹€æ…‹: <span id="status-${deviceId}">é‡‹æ”¾</span>
            </div>
            <div class="text-muted small">
              æ™‚é–“: <span id="time-${deviceId}">-</span>
            </div>
          </div>
        `;
        devicesRow.appendChild(cardCol);
        card = document.getElementById(`device-${deviceId}`);
      }
      
      // æ›´æ–°å¡ç‰‡ç‹€æ…‹
      const indicator = document.getElementById(`indicator-${deviceId}`);
      const statusText = document.getElementById(`status-${deviceId}`);
      const timeText = document.getElementById(`time-${deviceId}`);
      
      if (touchState === 1) {
        card.className = 'device-card touched';
        indicator.className = 'status-indicator status-touched me-2';
        statusText.textContent = 'è§¸æ‘¸';
        statusText.style.color = '#f59e0b';
        statusText.style.fontWeight = 'bold';
      } else {
        card.className = 'device-card released';
        indicator.className = 'status-indicator status-released me-2';
        statusText.textContent = 'é‡‹æ”¾';
        statusText.style.color = '#6b7280';
        statusText.style.fontWeight = 'normal';
      }
      
      const date = new Date(timestamp);
      timeText.textContent = date.toLocaleTimeString('zh-TW', { hour12: false });
    }

    // é€£æ¥ MQTT
    function connectMQTT() {
      const url = document.getElementById('mqttUrl').value.trim();
      if (!url) {
        addLog('è«‹è¼¸å…¥ MQTT URL', 'error');
        return;
      }

      addLog(`æ­£åœ¨é€£ç·šåˆ° ${url}...`, 'info');
      
      mqttClient = mqtt.connect(url);

      mqttClient.on('connect', () => {
        addLog('âœ“ MQTT é€£ç·šæˆåŠŸï¼', 'success');
        updateConnectionStatus(true);
        
        // è¨‚é–±æ‰€æœ‰ ESP32 ç¾¤çµ„çš„è§¸æ‘¸ä¸»é¡Œ
        mqttClient.subscribe('esp32-+/sensor/touch', (err) => {
          if (!err) {
            addLog('å·²è¨‚é–±ä¸»é¡Œ: esp32-+/sensor/touch', 'success');
          }
        });
      });

      mqttClient.on('message', (topic, payload) => {
        try {
          const data = JSON.parse(payload.toString());
          const { touch, device, timestamp } = data;
          
          // æ›´æ–°è¨­å‚™å¡ç‰‡
          updateDeviceCard(device, touch, timestamp || Date.now());
          
          // è¨˜éŒ„æ—¥èªŒ
          const status = touch === 1 ? 'è§¸æ‘¸' : 'é‡‹æ”¾';
          const logType = touch === 1 ? 'touch' : 'release';
          addLog(`[${topic}] ${device}: ${status}`, logType);
          
        } catch (err) {
          addLog(`è§£æéŒ¯èª¤: ${err.message}`, 'error');
        }
      });

      mqttClient.on('error', (err) => {
        addLog(`âŒ éŒ¯èª¤: ${err.message}`, 'error');
      });

      mqttClient.on('close', () => {
        addLog('é€£ç·šå·²é—œé–‰', 'info');
        updateConnectionStatus(false);
      });

      mqttClient.on('offline', () => {
        addLog('é›¢ç·š', 'error');
        updateConnectionStatus(false);
      });
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('btnConnect').addEventListener('click', connectMQTT);
    document.getElementById('btnClearLog').addEventListener('click', () => {
      document.getElementById('logContainer').innerHTML = '';
      addLog('æ—¥èªŒå·²æ¸…é™¤', 'info');
    });

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      addLog('ğŸš€ ESP32 å¤šè¨­å‚™ç›£æ§ç³»çµ±å·²å°±ç·’', 'success');
      addLog('ğŸ’¡ é»æ“Šã€Œé€£ç·šã€é–‹å§‹ç›£æ§æ‰€æœ‰ ESP32 è¨­å‚™', 'info');
    });
  </script>
</body>
</html>
