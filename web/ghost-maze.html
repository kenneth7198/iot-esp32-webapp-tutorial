<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÉ Ëê¨ËÅñÁØÄÈ¨ºÂ±ãËø∑ÂÆÆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #ff6b00;
      overflow: hidden;
      height: 100vh;
    }

    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding-right: 300px; /* ÁÇ∫Âè≥ÂÅ¥ÁãÄÊÖãÈù¢ÊùøÁïôÂá∫Á©∫Èñì */
    }

    .header {
      background: linear-gradient(180deg, #1a0a00, #0a0a0a);
      padding: 20px;
      text-align: center;
      border-bottom: 3px solid #ff6b00;
      box-shadow: 0 5px 20px rgba(255, 107, 0, 0.5);
    }

    .header h1 {
      font-size: 48px;
      text-shadow: 0 0 20px #ff6b00, 0 0 40px #ff3300;
      margin-bottom: 10px;
      animation: flicker 3s infinite;
    }

    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
      75% { opacity: 0.9; }
    }

    .subtitle {
      font-size: 18px;
      color: #ffaa00;
      opacity: 0.8;
    }

    .maze-container {
      flex: 1;
      position: relative;
      background: 
        radial-gradient(circle at 20% 30%, rgba(255, 107, 0, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.05) 0%, transparent 50%),
        #0a0a0a;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .maze-grid {
      width: min(calc(100vh - 200px), calc(100vw - 400px)); /* Ê≠£ÊñπÂΩ¢Â∞∫ÂØ∏ */
      height: min(calc(100vh - 200px), calc(100vw - 400px));
      max-width: 800px;
      max-height: 800px;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 2px;
      background: rgba(20, 10, 0, 0.5);
      border: 3px solid #ff6b00;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 30px rgba(255, 107, 0, 0.3);
    }

    .maze-cell {
      background: rgba(50, 20, 0, 0.3);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 5px;
      position: relative;
      transition: all 0.3s;
    }

    .maze-cell.wall {
      background: rgba(100, 40, 0, 0.6);
      border-color: rgba(255, 107, 0, 0.4);
    }

    .maze-cell:hover {
      background: rgba(255, 107, 0, 0.1);
    }

    .ghost {
      position: fixed;
      width: 60px;
      height: 60px;
      font-size: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      cursor: pointer;
      filter: drop-shadow(0 0 10px currentColor);
      animation: float 3s ease-in-out infinite;
      opacity: 0;
      transform: scale(0);
      pointer-events: none; /* ÈÅøÂÖçÈÅÆÊìãÈªûÊìä */
    }

    .ghost.active {
      opacity: 1;
      transform: scale(1);
      animation: float 3s ease-in-out infinite, appear 0.5s ease-out;
    }

    .ghost.hidden {
      opacity: 0.2;
      transform: scale(0.5);
      filter: grayscale(100%) brightness(0.5);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-15px) scale(1.05); }
    }

    @keyframes appear {
      from {
        opacity: 0;
        transform: scale(0) rotate(360deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }

    .ghost-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      background: rgba(0, 0, 0, 0.8);
      padding: 2px 8px;
      border-radius: 10px;
      white-space: nowrap;
      border: 1px solid currentColor;
    }

    .ghost-light-value {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      background: rgba(0, 0, 0, 0.9);
      padding: 2px 6px;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0.7;
    }

    .status-panel {
      position: fixed;
      top: 100px;
      right: 20px;
      width: 280px;
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #ff6b00;
      border-radius: 15px;
      padding: 20px;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
      box-shadow: 0 0 30px rgba(255, 107, 0, 0.5);
      z-index: 100;
    }

    .status-title {
      font-size: 20px;
      margin-bottom: 15px;
      text-align: center;
      color: #ffaa00;
    }

    .game-info {
      background: rgba(255, 107, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
      border: 2px solid #ff6b00;
    }

    .timer {
      font-size: 32px;
      font-weight: bold;
      color: #ffaa00;
      margin-bottom: 10px;
      text-shadow: 0 0 10px #ff6b00;
    }

    .timer.warning {
      color: #ff0000;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .ghost-status {
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 107, 0, 0.1);
      border-radius: 8px;
      border-left: 3px solid #ff6b00;
    }

    .ghost-status.active {
      border-left-color: #00ff00;
      animation: glow 2s infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.3); }
      50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.6); }
    }

    .ghost-status-name {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ghost-score {
      font-size: 16px;
      color: #ffaa00;
      font-weight: bold;
    }

    .ghost-status-info {
      font-size: 12px;
      opacity: 0.8;
    }

    .treasure {
      position: fixed;
      width: 40px;
      height: 40px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 45;
      animation: treasure-glow 2s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes treasure-glow {
      0%, 100% { 
        transform: translate(-50%, -50%) scale(1);
        filter: drop-shadow(0 0 5px gold);
      }
      50% { 
        transform: translate(-50%, -50%) scale(1.2);
        filter: drop-shadow(0 0 20px gold);
      }
    }

    .collision-effect {
      position: fixed;
      font-size: 48px;
      z-index: 999;
      animation: collision-pop 1s ease-out forwards;
      pointer-events: none;
    }

    @keyframes collision-pop {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.5);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5) translateY(-100px);
      }
    }

    .connection-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 25px;
      border: 2px solid #ff6b00;
    }

    .connection-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
      box-shadow: 0 0 10px currentColor;
      animation: blink 1s infinite;
    }

    .connection-dot.connected {
      background: #0f0;
      animation: none;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .music-control {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 25px;
      border: 2px solid #ff6b00;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      z-index: 1000;
    }

    .music-control:hover {
      background: rgba(255, 107, 0, 0.3);
      transform: scale(1.05);
    }

    .music-icon {
      font-size: 20px;
      animation: pulse-music 2s infinite;
    }

    .music-control.muted .music-icon {
      animation: none;
      opacity: 0.5;
    }

    @keyframes pulse-music {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .instructions {
      position: fixed;
      top: 120px;
      left: 20px;
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #ff6b00;
      border-radius: 15px;
      padding: 15px 20px;
      text-align: left;
      max-width: 280px;
      box-shadow: 0 0 20px rgba(255, 107, 0, 0.3);
      z-index: 90;
    }

    .instructions-title {
      font-size: 16px;
      margin-bottom: 10px;
      color: #ffaa00;
      font-weight: bold;
    }

    .instructions-text {
      font-size: 13px;
      line-height: 1.8;
      color: #fff;
    }

    .instructions-link {
      display: none; /* Èö±ËóèÊâãÊ©üÊéßÂà∂Âô®ÊåâÈàï */
    }

    .youtube-player {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 320px;
      height: 180px;
      border: 3px solid #ff6b00;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(255, 107, 0, 0.5);
      z-index: 100;
      background: #000;
    }

    .youtube-player iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .youtube-toggle {
      position: fixed;
      bottom: 210px;
      left: 20px;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ff6b00;
      border-radius: 10px;
      padding: 8px 15px;
      cursor: pointer;
      color: #ffaa00;
      font-size: 14px;
      transition: all 0.3s;
      z-index: 101;
    }

    .youtube-toggle:hover {
      background: rgba(255, 107, 0, 0.3);
      transform: scale(1.05);
    }

    .youtube-player.hidden {
      display: none;
    }

    /* ÊªæÂãïÊ¢ùÊ®£Âºè */
    .status-panel::-webkit-scrollbar {
      width: 8px;
    }

    .status-panel::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
    }

    .status-panel::-webkit-scrollbar-thumb {
      background: #ff6b00;
      border-radius: 10px;
    }

    .status-panel::-webkit-scrollbar-thumb:hover {
      background: #ffaa00;
    }

    /* ÈüøÊáâÂºèË®≠Ë®à */
    @media (max-width: 1400px) {
      .instructions {
        font-size: 12px;
        padding: 12px 15px;
        max-width: 250px;
      }

      .instructions-title {
        font-size: 14px;
      }

      .instructions-text {
        font-size: 12px;
      }
    }

    @media (max-width: 1200px) {
      .container {
        padding-right: 0;
      }

      .status-panel {
        width: 240px;
        padding: 15px;
        font-size: 14px;
      }

      .maze-grid {
        width: min(calc(100vh - 200px), calc(100vw - 300px));
        height: min(calc(100vh - 200px), calc(100vw - 300px));
      }

      .instructions {
        top: auto;
        bottom: 20px;
        left: 20px;
        max-width: 220px;
      }
    }

    @media (max-width: 768px) {
      .status-panel {
        top: auto;
        bottom: 20px;
        right: 20px;
        width: 200px;
        max-height: 40vh;
      }

      .instructions {
        display: none; /* Â∞èËû¢ÂπïÈö±ËóèË™™Êòé */
      }

      .maze-grid {
        width: min(calc(100vh - 150px), calc(100vw - 40px));
        height: min(calc(100vh - 150px), calc(100vw - 40px));
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Ê®ôÈ°å -->
    <div class="header">
      <h1>üéÉ Ëê¨ËÅñÁØÄÈ¨ºÂ±ãËø∑ÂÆÆ üëª</h1>
      <div class="subtitle">Âú∞‰∏ãËø∑ÂÆÆÊé¢Èö™ - Áî®ÊâãÈõªÁ≠íÂñöÈÜí‰Ω†ÁöÑÈ¨ºÈ≠Ç</div>
    </div>

    <!-- Ëø∑ÂÆÆÂçÄÂüü -->
    <div class="maze-container" id="mazeContainer">
      <div class="maze-grid" id="mazeGrid"></div>
    </div>

    <!-- ÈÄ£Á∑öÊåáÁ§∫Âô® -->
    <div class="connection-indicator">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">ÈÄ£Êé•‰∏≠...</span>
    </div>

    <!-- Èü≥Ê®ÇÊéßÂà∂ -->
    <div class="music-control" id="musicControl" title="ÈªûÊìäÈñãÂïü/ÈóúÈñâÈü≥Ê®Ç">
      <span class="music-icon">üéµ</span>
      <span id="musicText">ÈªûÊìäÊí≠Êîæ</span>
    </div>

    <!-- ÁãÄÊÖãÈù¢Êùø -->
    <div class="status-panel">
      <div class="game-info">
        <div class="timer" id="timer">03:00</div>
        <div style="font-size: 14px; color: #fff;">‚è∞ Ââ©È§òÊôÇÈñì</div>
      </div>
      <div class="status-title">üëª È¨ºÈ≠ÇÁãÄÊÖã</div>
      <div id="ghostStatusList"></div>
    </div>

    <!-- Êìç‰ΩúË™™Êòé -->
    <div class="instructions">
      <div class="instructions-title">üì± Â¶Ç‰ΩïÊìç‰Ωú</div>
      <div class="instructions-text">
        1. Áî®ÊâãÈõªÁ≠íÁÖß‰∫Æ ESP32 ÂÖâÊïèÈõªÈòª<br>
        2. ÊâãÊ©üÈñãÂïüÊéßÂà∂Âô®Á∂≤È†Å<br>
        3. ÂÖâÁ∑öÂÖÖË∂≥ÂæåËá™ÂãïÂïüÂãïÊéßÂà∂<br>
        4. ‰ΩøÁî®ÊñπÂêëÈçµÊéßÂà∂È¨ºÈ≠ÇÁßªÂãï<br>
        5. Êåâ‰∏ã üíé ÊåâÈàïÊäìÂèñÂØ∂Áâ©<br>
        6. ÈÅøÂÖçÁ¢∞ÊíûÔºåÊê∂Â•™ÂØ∂Áâ©ÂæóÂàÜ
      </div>
    </div>

    <!-- YouTube Èü≥Ê®ÇÊí≠ÊîæÂô®ÂàáÊèõÊåâÈàï -->
    <div class="youtube-toggle" id="youtubeToggle">
      üéµ È°ØÁ§∫/Èö±ËóèÈü≥Ê®Ç
    </div>

    <!-- YouTube Èü≥Ê®ÇÊí≠ÊîæÂô® -->
    <div class="youtube-player" id="youtubePlayer">
      <iframe 
        src="https://www.youtube.com/embed/wTZZNpuZYTI?autoplay=1&loop=1&playlist=wTZZNpuZYTI&controls=1" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
      </iframe>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <script>
    // ========== Ë®≠ÂÆö ==========
    const WS_URL = 'ws://192.168.100.200:8080';
    const GHOST_COUNT = 9;
    const MAZE_SIZE = 10;
    const CELL_SIZE = 60;
    const LIGHT_THRESHOLD = 3000;
    const GAME_DURATION = 180; // 3ÂàÜÈêò = 180Áßí
    const COLLISION_PENALTY = -100; // Á¢∞ÊíûÊâ£ÂàÜ
    const TREASURE_REWARD = 500; // ÂØ∂Áâ©Âä†ÂàÜ
    const MIN_TREASURES = 10;
    const MAX_TREASURES = 15;

    // È¨ºÈ≠ÇÈ°èËâ≤
    const GHOST_COLORS = [
      '#ff6b00', '#ff00ff', '#00ffff', '#ffff00', 
      '#ff0099', '#00ff99', '#9900ff', '#ff9900', '#00ff00'
    ];

    // È¨ºÈ≠ÇË°®ÊÉÖÁ¨¶Ëôü
    const GHOST_EMOJIS = ['üëª', 'üéÉ', 'ü¶á', 'üíÄ', 'üï∑Ô∏è', 'üï∏Ô∏è', 'üßõ', 'üßü', 'üëπ'];

    // ========== ÁãÄÊÖã ==========
    let ws = null;
    const ghosts = new Map();  // device-01 -> {x, y, light, active, element, score}
    const treasures = []; // [{x, y, element}]
    let gameTimer = GAME_DURATION;
    let gameInterval = null;
    let gameStarted = false;

    // ========== DOM ÂÖÉÁ¥† ==========
    const mazeContainerEl = document.getElementById('mazeContainer');
    const mazeGridEl = document.getElementById('mazeGrid');
    const connectionDotEl = document.getElementById('connectionDot');
    const connectionTextEl = document.getElementById('connectionText');
    const ghostStatusListEl = document.getElementById('ghostStatusList');
    const timerEl = document.getElementById('timer');
    const musicControlEl = document.getElementById('musicControl');
    const musicTextEl = document.getElementById('musicText');
    const youtubePlayerEl = document.getElementById('youtubePlayer');
    const youtubeToggleEl = document.getElementById('youtubeToggle');
    
    let isMusicPlaying = false;
    let audioContext = null;
    let bgMusicOscillator = null;
    let isYoutubeVisible = true;

    // ========== ÂàùÂßãÂåñËø∑ÂÆÆ ==========
    function initMaze() {
      // Âª∫Á´ã 10x10 Ê†ºÂ≠ê
      for (let row = 0; row < MAZE_SIZE; row++) {
        for (let col = 0; col < MAZE_SIZE; col++) {
          const cell = document.createElement('div');
          cell.className = 'maze-cell';
          cell.dataset.row = row;
          cell.dataset.col = col;
          
          // Èö®Ê©üÂä†ÂÖ•ÁâÜÂ£ÅÔºà20% Ê©üÁéáÔºâ
          if (Math.random() < 0.2) {
            cell.classList.add('wall');
          }
          
          mazeGridEl.appendChild(cell);
        }
      }
    }

    // ========== ÂàùÂßãÂåñÈ¨ºÈ≠Ç ==========
    function initGhosts() {
      for (let i = 1; i <= GHOST_COUNT; i++) {
        const deviceId = `esp32-device-${String(i).padStart(2, '0')}`;
        const ghost = {
          device: deviceId,
          x: Math.floor(Math.random() * MAZE_SIZE),
          y: Math.floor(Math.random() * MAZE_SIZE),
          light: 0,
          active: false,
          color: GHOST_COLORS[i - 1],
          emoji: GHOST_EMOJIS[i - 1],
          element: null,
          score: 0 // Êñ∞Â¢ûÂàÜÊï∏
        };
        
        ghosts.set(deviceId, ghost);
        createGhostElement(ghost);
        createGhostStatus(ghost);
      }
    }

    // ========== ÂàùÂßãÂåñÂØ∂Áâ© ==========
    function initTreasures() {
      const treasureCount = Math.floor(Math.random() * (MAX_TREASURES - MIN_TREASURES + 1)) + MIN_TREASURES;
      const usedPositions = new Set();
      
      // Ë®òÈåÑÈ¨ºÈ≠ÇÂàùÂßã‰ΩçÁΩÆÔºåÈÅøÂÖçÈáçÁñä
      ghosts.forEach(ghost => {
        usedPositions.add(`${ghost.x},${ghost.y}`);
      });
      
      for (let i = 0; i < treasureCount; i++) {
        let x, y, posKey;
        let attempts = 0;
        
        // Â∞ãÊâæ‰∏çÈáçÁñäÁöÑ‰ΩçÁΩÆ
        do {
          x = Math.floor(Math.random() * MAZE_SIZE);
          y = Math.floor(Math.random() * MAZE_SIZE);
          posKey = `${x},${y}`;
          attempts++;
        } while (usedPositions.has(posKey) && attempts < 100);
        
        if (attempts < 100) {
          usedPositions.add(posKey);
          
          const treasure = { x, y, element: null };
          createTreasureElement(treasure);
          treasures.push(treasure);
        }
      }
      
      console.log(`üíé ÁîüÊàê‰∫Ü ${treasures.length} ÂÄãÂØ∂Áâ©`);
    }

    // ========== Âª∫Á´ãÂØ∂Áâ©ÂÖÉÁ¥† ==========
    function createTreasureElement(treasure) {
      const treasureEl = document.createElement('div');
      treasureEl.className = 'treasure';
      treasureEl.innerHTML = 'üíé';
      treasureEl.style.position = 'fixed';
      treasureEl.style.zIndex = '45';
      
      treasure.element = treasureEl;
      document.body.appendChild(treasureEl);
      
      updateTreasurePosition(treasure);
    }

    // ========== Êõ¥Êñ∞ÂØ∂Áâ©‰ΩçÁΩÆ ==========
    function updateTreasurePosition(treasure) {
      const gridRect = mazeGridEl.getBoundingClientRect();
      const cellWidth = gridRect.width / MAZE_SIZE;
      const cellHeight = gridRect.height / MAZE_SIZE;
      
      const x = gridRect.left + (treasure.x + 0.5) * cellWidth;
      const y = gridRect.top + (treasure.y + 0.5) * cellHeight;
      
      treasure.element.style.left = `${x}px`;
      treasure.element.style.top = `${y}px`;
      treasure.element.style.transform = `translate(-50%, -50%)`;
    }

    // ========== Âª∫Á´ãÈ¨ºÈ≠ÇÂÖÉÁ¥† ==========
    function createGhostElement(ghost) {
      const ghostEl = document.createElement('div');
      ghostEl.className = 'ghost hidden';
      ghostEl.innerHTML = ghost.emoji;
      ghostEl.style.color = ghost.color;
      ghostEl.style.position = 'fixed'; // ‰ΩøÁî® fixed ÂÆö‰Ωç
      ghostEl.style.zIndex = '50';
      
      // Ê®ôÁ±§
      const label = document.createElement('div');
      label.className = 'ghost-label';
      label.textContent = ghost.device.split('-')[2];
      label.style.color = ghost.color;
      ghostEl.appendChild(label);
      
      // ÂÖâÁ∑öÊï∏ÂÄº
      const lightValue = document.createElement('div');
      lightValue.className = 'ghost-light-value';
      lightValue.textContent = 'üí° 0';
      ghostEl.appendChild(lightValue);
      
      ghost.element = ghostEl;
      document.body.appendChild(ghostEl); // ÈôÑÂä†Âà∞ body
      
      updateGhostPosition(ghost);
    }

    // ========== Êõ¥Êñ∞È¨ºÈ≠Ç‰ΩçÁΩÆ ==========
    function updateGhostPosition(ghost) {
      const gridRect = mazeGridEl.getBoundingClientRect();
      
      // Ë®àÁÆóÊØèÂÄãÊ†ºÂ≠êÁöÑÂØ¶ÈöõÂ∞∫ÂØ∏
      const cellWidth = gridRect.width / MAZE_SIZE;
      const cellHeight = gridRect.height / MAZE_SIZE;
      
      // Ë®àÁÆóÈ¨ºÈ≠ÇÁöÑÁµïÂ∞ç‰ΩçÁΩÆÔºàÁõ∏Â∞çÊñºË¶ñÁ™óÔºâ
      const x = gridRect.left + (ghost.x + 0.5) * cellWidth;
      const y = gridRect.top + (ghost.y + 0.5) * cellHeight;
      
      // Ë®≠ÂÆöÈ¨ºÈ≠Ç‰ΩçÁΩÆÔºàfixed ÂÆö‰ΩçÔºâ
      ghost.element.style.position = 'fixed';
      ghost.element.style.left = `${x}px`;
      ghost.element.style.top = `${y}px`;
      ghost.element.style.transform = `translate(-50%, -50%)`;
    }

    // ========== Âª∫Á´ãÈ¨ºÈ≠ÇÁãÄÊÖãÈ°ØÁ§∫ ==========
    function createGhostStatus(ghost) {
      const statusEl = document.createElement('div');
      statusEl.className = 'ghost-status';
      statusEl.id = `status-${ghost.device}`;
      statusEl.innerHTML = `
        <div class="ghost-status-name" style="color: ${ghost.color};">
          <span>${ghost.emoji} ${ghost.device.split('-')[2]}</span>
          <span class="ghost-score" id="score-${ghost.device}">0ÂàÜ</span>
        </div>
        <div class="ghost-status-info">
          üí° ÂÖâÁ∑ö: <span id="light-${ghost.device}">0</span><br>
          üìç ‰ΩçÁΩÆ: (<span id="pos-${ghost.device}">0, 0</span>)<br>
          ‚ö° ÁãÄÊÖã: <span id="active-${ghost.device}">Èö±Ëóè</span>
        </div>
      `;
      ghostStatusListEl.appendChild(statusEl);
    }

    // ========== Êõ¥Êñ∞ÂàÜÊï∏ ==========
    function updateScore(deviceId, points, reason) {
      const ghost = ghosts.get(deviceId);
      if (!ghost) return;
      
      ghost.score += points;
      
      // Êõ¥Êñ∞È°ØÁ§∫
      const scoreEl = document.getElementById(`score-${deviceId}`);
      if (scoreEl) {
        scoreEl.textContent = `${ghost.score}ÂàÜ`;
      }
      
      console.log(`üí∞ ${deviceId} ${reason}: ${points > 0 ? '+' : ''}${points}ÂàÜÔºàÁ∏ΩÂàÜ: ${ghost.score}Ôºâ`);
    }

    // ========== Êõ¥Êñ∞È¨ºÈ≠ÇÁãÄÊÖã ==========
    function updateGhostStatus(deviceId, data) {
      const ghost = ghosts.get(deviceId);
      if (!ghost) return;

      if (data.light !== undefined) {
        ghost.light = data.light;
        ghost.active = data.active;
        
        // Êõ¥Êñ∞Ë¶ñË¶∫
        if (ghost.active) {
          ghost.element.classList.remove('hidden');
          ghost.element.classList.add('active');
        } else {
          ghost.element.classList.add('hidden');
          ghost.element.classList.remove('active');
        }
        
        // Êõ¥Êñ∞ÂÖâÁ∑öÊï∏ÂÄºÈ°ØÁ§∫
        const lightValueEl = ghost.element.querySelector('.ghost-light-value');
        lightValueEl.textContent = `üí° ${ghost.light}`;
        
        // Êõ¥Êñ∞ÁãÄÊÖãÈù¢Êùø
        const statusEl = document.getElementById(`status-${deviceId}`);
        if (statusEl) {
          if (ghost.active) {
            statusEl.classList.add('active');
          } else {
            statusEl.classList.remove('active');
          }
          
          document.getElementById(`light-${deviceId}`).textContent = ghost.light;
          document.getElementById(`pos-${deviceId}`).textContent = `${ghost.x}, ${ghost.y}`;
          document.getElementById(`active-${deviceId}`).textContent = ghost.active ? '‚úÖ È°ØÁ§∫' : '‚ùå Èö±Ëóè';
        }
      }
    }

    // ========== ÁßªÂãïÈ¨ºÈ≠Ç ==========
    function moveGhost(deviceId, direction) {
      const ghost = ghosts.get(deviceId);
      if (!ghost || !ghost.active) {
        console.log(`‚ùå ${deviceId} ÁÑ°Ê≥ïÁßªÂãïÔºàÊú™ÊøÄÊ¥ªÊàñ‰∏çÂ≠òÂú®Ôºâ`);
        return;
      }

      const oldX = ghost.x;
      const oldY = ghost.y;

      // Ë®àÁÆóÊñ∞‰ΩçÁΩÆ
      switch (direction) {
        case 'up':
          ghost.y = Math.max(0, ghost.y - 1);
          break;
        case 'down':
          ghost.y = Math.min(MAZE_SIZE - 1, ghost.y + 1);
          break;
        case 'left':
          ghost.x = Math.max(0, ghost.x - 1);
          break;
        case 'right':
          ghost.x = Math.min(MAZE_SIZE - 1, ghost.x + 1);
          break;
      }

      // Ê™¢Êü•ÊòØÂê¶Á¢∞Âà∞ÁâÜÂ£Å
      const cell = document.querySelector(`[data-row="${ghost.y}"][data-col="${ghost.x}"]`);
      if (cell && cell.classList.contains('wall')) {
        // ÊíûÁâÜÔºåÊÅ¢Âæ©‰ΩçÁΩÆ
        ghost.x = oldX;
        ghost.y = oldY;
        console.log(`üß± ${deviceId} ÊíûÁâÜ‰∫ÜÔºÅ`);
        return;
      }

      console.log(`üéÆ ${deviceId} ÁßªÂãïÂà∞ (${ghost.x}, ${ghost.y})`);
      updateGhostPosition(ghost);
      
      // Êõ¥Êñ∞ÁãÄÊÖãÈù¢Êùø
      document.getElementById(`pos-${deviceId}`).textContent = `${ghost.x}, ${ghost.y}`;
      
      // Ê™¢Êü•Á¢∞Êíû
      checkCollisions(deviceId);
    }

    // ========== Ê™¢Êü•Á¢∞Êíû ==========
    function checkCollisions(movedGhostId) {
      const movedGhost = ghosts.get(movedGhostId);
      if (!movedGhost || !movedGhost.active) return;

      // Ê™¢Êü•ËàáÂÖ∂‰ªñÈ¨ºÈ≠ÇÁöÑÁ¢∞Êíû
      ghosts.forEach((otherGhost, otherId) => {
        if (otherId !== movedGhostId && 
            otherGhost.active && 
            otherGhost.x === movedGhost.x && 
            otherGhost.y === movedGhost.y) {
          
          // ÂÖ©ÂÄãÈ¨ºÈ≠ÇÈÉΩÊòØÈ°ØÁ§∫ÁãÄÊÖãÔºåÁôºÁîüÁ¢∞Êíû
          console.log(`üí• Á¢∞ÊíûÔºÅ${movedGhostId} Ëàá ${otherId}`);
          
          // ÂÖ©ÂÄãÈÉΩÊâ£ÂàÜ
          updateScore(movedGhostId, COLLISION_PENALTY, 'È¨ºÈ≠ÇÁ¢∞Êíû');
          updateScore(otherId, COLLISION_PENALTY, 'È¨ºÈ≠ÇÁ¢∞Êíû');
          
          // È°ØÁ§∫Á¢∞ÊíûÊïàÊûú
          showCollisionEffect(movedGhost);
        }
      });
    }

    // ========== È°ØÁ§∫Á¢∞ÊíûÊïàÊûú ==========
    function showCollisionEffect(ghost) {
      const effectEl = document.createElement('div');
      effectEl.className = 'collision-effect';
      effectEl.innerHTML = 'üí•';
      effectEl.style.color = '#ff0000';
      
      const gridRect = mazeGridEl.getBoundingClientRect();
      const cellWidth = gridRect.width / MAZE_SIZE;
      const cellHeight = gridRect.height / MAZE_SIZE;
      
      const x = gridRect.left + (ghost.x + 0.5) * cellWidth;
      const y = gridRect.top + (ghost.y + 0.5) * cellHeight;
      
      effectEl.style.position = 'fixed';
      effectEl.style.left = `${x}px`;
      effectEl.style.top = `${y}px`;
      
      document.body.appendChild(effectEl);
      
      // 1ÁßíÂæåÁßªÈô§
      setTimeout(() => {
        effectEl.remove();
      }, 1000);
    }

    // ========== ÊäìÂèñÂØ∂Áâ© ==========
    function grabTreasure(deviceId) {
      const ghost = ghosts.get(deviceId);
      if (!ghost || !ghost.active) {
        console.log(`‚ùå ${deviceId} ÁÑ°Ê≥ïÊäìÂèñÂØ∂Áâ©ÔºàÊú™ÊøÄÊ¥ªÔºâ`);
        return;
      }

      // Êü•ÊâæÁï∂Ââç‰ΩçÁΩÆÊòØÂê¶ÊúâÂØ∂Áâ©
      const treasureIndex = treasures.findIndex(t => 
        t.x === ghost.x && t.y === ghost.y
      );

      if (treasureIndex !== -1) {
        // ÊâæÂà∞ÂØ∂Áâ©ÔºÅ
        const treasure = treasures[treasureIndex];
        
        console.log(`üéâ ${deviceId} ÊäìÂà∞ÂØ∂Áâ©ÔºÅ‰ΩçÁΩÆ: (${treasure.x}, ${treasure.y})`);
        
        // Âä†ÂàÜ
        updateScore(deviceId, TREASURE_REWARD, 'ÊäìÂèñÂØ∂Áâ©');
        
        // ÁßªÈô§ÂØ∂Áâ©
        treasure.element.remove();
        treasures.splice(treasureIndex, 1);
        
        // È°ØÁ§∫ÂØ∂Áâ©Áç≤ÂæóÊïàÊûú
        showTreasureEffect(ghost);
      } else {
        console.log(`‚ùå ${deviceId} ÈÄôË£°Ê≤íÊúâÂØ∂Áâ©`);
      }
    }

    // ========== È°ØÁ§∫ÂØ∂Áâ©Áç≤ÂæóÊïàÊûú ==========
    function showTreasureEffect(ghost) {
      const effectEl = document.createElement('div');
      effectEl.className = 'collision-effect';
      effectEl.innerHTML = `+${TREASURE_REWARD}üíé`;
      effectEl.style.color = '#ffd700';
      
      const gridRect = mazeGridEl.getBoundingClientRect();
      const cellWidth = gridRect.width / MAZE_SIZE;
      const cellHeight = gridRect.height / MAZE_SIZE;
      
      const x = gridRect.left + (ghost.x + 0.5) * cellWidth;
      const y = gridRect.top + (ghost.y + 0.5) * cellHeight;
      
      effectEl.style.position = 'fixed';
      effectEl.style.left = `${x}px`;
      effectEl.style.top = `${y}px`;
      
      document.body.appendChild(effectEl);
      
      setTimeout(() => {
        effectEl.remove();
      }, 1000);
    }

    // ========== WebSocket ÈÄ£Êé• ==========
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('‚úÖ WebSocket ÈÄ£Êé•ÊàêÂäü');
        connectionDotEl.classList.add('connected');
        connectionTextEl.textContent = 'Â∑≤ÈÄ£Êé•';
        
        // Ë®ÇÈñ±ÊâÄÊúâË£ùÁΩÆÁöÑÂÖâÁ∑öÊï∏ÊìöÂíåÁßªÂãïÊåá‰ª§
        for (let i = 1; i <= GHOST_COUNT; i++) {
          const deviceId = `esp32-device-${String(i).padStart(2, '0')}`;
          
          // Ë®ÇÈñ±ÂÖâÁ∑öÊï∏Êìö
          ws.send(JSON.stringify({
            type: 'subscribe',
            topic: `esp32/${deviceId}/light`
          }));
          
          // Ë®ÇÈñ±ÁßªÂãïÊåá‰ª§
          ws.send(JSON.stringify({
            type: 'subscribe',
            topic: `ghost/move/${deviceId}`
          }));
          
          // Ë®ÇÈñ±ÊäìÂèñÂØ∂Áâ©Êåá‰ª§
          ws.send(JSON.stringify({
            type: 'subscribe',
            topic: `ghost/grab/${deviceId}`
          }));
        }
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error('Ëß£ÊûêË®äÊÅØÂ§±Êïó:', e);
        }
      };
      
      ws.onerror = (error) => {
        console.error('‚ùå WebSocket ÈåØË™§:', error);
        connectionTextEl.textContent = 'ÈÄ£Êé•ÈåØË™§';
      };
      
      ws.onclose = () => {
        console.log('üîå WebSocket Â∑≤Êñ∑ÈñãÔºå3 ÁßíÂæåÈáçÈÄ£...');
        connectionDotEl.classList.remove('connected');
        connectionTextEl.textContent = 'Â∑≤Êñ∑Èñã';
        setTimeout(connectWebSocket, 3000);
      };
    }

    // ========== ËôïÁêÜË®äÊÅØ ==========
    function handleMessage(data) {
      if (!data.topic) return;

      if (data.topic.includes('/light')) {
        // ÂÖâÁ∑öÊï∏Êìö
        const payload = JSON.parse(data.payload);
        const deviceId = payload.device;
        updateGhostStatus(deviceId, payload);
        
        // Á¨¨‰∏ÄÊ¨°ÊúâÈ¨ºÈ≠ÇÊøÄÊ¥ªÊôÇÈñãÂßãÈÅäÊà≤
        if (!gameStarted && payload.active) {
          startGame();
        }
      } else if (data.topic.includes('ghost/move/')) {
        // ÁßªÂãïÊåá‰ª§
        const payload = JSON.parse(data.payload);
        const deviceId = payload.device;
        const direction = payload.direction;
        moveGhost(deviceId, direction);
      } else if (data.topic.includes('ghost/grab/')) {
        // ÊäìÂèñÂØ∂Áâ©Êåá‰ª§
        const payload = JSON.parse(data.payload);
        const deviceId = payload.device;
        grabTreasure(deviceId);
      }
    }

    // ========== ÈñãÂßãÈÅäÊà≤ ==========
    function startGame() {
      if (gameStarted) return;
      
      gameStarted = true;
      console.log('üéÆ ÈÅäÊà≤ÈñãÂßãÔºÅ');
      
      // ÈñãÂßãÂÄíË®àÊôÇ
      gameInterval = setInterval(() => {
        gameTimer--;
        updateTimer();
        
        if (gameTimer <= 0) {
          endGame();
        }
      }, 1000);
    }

    // ========== Êõ¥Êñ∞Ë®àÊôÇÂô® ==========
    function updateTimer() {
      const minutes = Math.floor(gameTimer / 60);
      const seconds = gameTimer % 60;
      const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      timerEl.textContent = timeStr;
      
      // ÊúÄÂæå30ÁßíËÆäÁ¥ÖËâ≤Ë≠¶Âëä
      if (gameTimer <= 30) {
        timerEl.classList.add('warning');
      }
    }

    // ========== ÁµêÊùüÈÅäÊà≤ ==========
    function endGame() {
      clearInterval(gameInterval);
      gameStarted = false;
      
      console.log('‚è∞ ÈÅäÊà≤ÁµêÊùüÔºÅ');
      
      // Ë®àÁÆóÊúÄÁµÇÊéíÂêç
      const rankings = Array.from(ghosts.values())
        .sort((a, b) => b.score - a.score)
        .map((ghost, index) => `${index + 1}. ${ghost.device.split('-')[2]} - ${ghost.score}ÂàÜ`)
        .join('\n');
      
      alert(`üèÅ ÈÅäÊà≤ÁµêÊùüÔºÅ\n\nÊúÄÁµÇÊéíÂêçÔºö\n${rankings}`);
      
      // ÂèØÈÅ∏ÔºöÈáçÊñ∞ÈñãÂßãÈÅäÊà≤
      if (confirm('ÊòØÂê¶ÈáçÊñ∞ÈñãÂßãÈÅäÊà≤Ôºü')) {
        location.reload();
      }
    }

    // ========== Ë¶ñÁ™óÂ§ßÂ∞èÊîπËÆäÊôÇÊõ¥Êñ∞‰ΩçÁΩÆ ==========
    window.addEventListener('resize', () => {
      ghosts.forEach(ghost => {
        updateGhostPosition(ghost);
      });
      treasures.forEach(treasure => {
        updateTreasurePosition(treasure);
      });
    });

    // ========== Èü≥Ê®ÇÊéßÂà∂ ==========
    // ‰ΩøÁî® Web Audio API ÁîüÊàêË±êÂØåÁöÑËê¨ËÅñÁØÄÊ∞õÂúçÈü≥Êïà
    function createSpookyAmbience() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      const nodes = [];

      // 1. ‰ΩéÈ†ª‰∏çÂÆâÊÑüÂü∫Â∫ïÔºàÊ∑±Ê≤âÁöÑÁÑ°Ë™øÈü≥Ôºâ
      const bass1 = audioContext.createOscillator();
      const bass2 = audioContext.createOscillator();
      const bassGain = audioContext.createGain();
      
      bass1.type = 'sine';
      bass1.frequency.setValueAtTime(55, audioContext.currentTime); // A1
      bass2.type = 'sine';
      bass2.frequency.setValueAtTime(58.27, audioContext.currentTime); // A#1 (‰∏çÂçîÂíåÈü≥Á®ã)
      
      bassGain.gain.setValueAtTime(0.08, audioContext.currentTime);
      
      bass1.connect(bassGain);
      bass2.connect(bassGain);
      bassGain.connect(audioContext.destination);
      
      nodes.push({ osc: bass1 }, { osc: bass2 });

      // 2. ‰∏≠È†ªË©≠Áï∞Èü≥ÊïàÔºàÊ®°Êì¨È¢®ËÅ≤Ôºâ
      const wind = audioContext.createOscillator();
      const windGain = audioContext.createGain();
      const windFilter = audioContext.createBiquadFilter();
      
      wind.type = 'sawtooth';
      wind.frequency.setValueAtTime(220, audioContext.currentTime);
      
      windFilter.type = 'lowpass';
      windFilter.frequency.setValueAtTime(400, audioContext.currentTime);
      windFilter.Q.setValueAtTime(5, audioContext.currentTime);
      
      windGain.gain.setValueAtTime(0.03, audioContext.currentTime);
      
      // È¢®ËÅ≤ÁöÑÈ°´ÂãïÊïàÊûú
      const windLFO = audioContext.createOscillator();
      const windLFOGain = audioContext.createGain();
      windLFO.frequency.setValueAtTime(0.3, audioContext.currentTime);
      windLFOGain.gain.setValueAtTime(100, audioContext.currentTime);
      
      windLFO.connect(windLFOGain);
      windLFOGain.connect(wind.frequency);
      
      wind.connect(windFilter);
      windFilter.connect(windGain);
      windGain.connect(audioContext.destination);
      
      nodes.push({ osc: wind }, { osc: windLFO });

      // 3. È´òÈ†ªË©≠Áï∞Èü≥ÊïàÔºàÂÉèÊòØÈÅ†ËôïÁöÑÂ∞ñÂè´Ôºâ
      const eerie = audioContext.createOscillator();
      const eerieGain = audioContext.createGain();
      const eerieFilter = audioContext.createBiquadFilter();
      
      eerie.type = 'triangle';
      eerie.frequency.setValueAtTime(880, audioContext.currentTime);
      
      eerieFilter.type = 'bandpass';
      eerieFilter.frequency.setValueAtTime(1200, audioContext.currentTime);
      eerieFilter.Q.setValueAtTime(10, audioContext.currentTime);
      
      eerieGain.gain.setValueAtTime(0.02, audioContext.currentTime);
      
      // È´òÈ†ªÁöÑÊÖ¢ÈÄüÈ°´Âãï
      const eerieLFO = audioContext.createOscillator();
      const eerieLFOGain = audioContext.createGain();
      eerieLFO.frequency.setValueAtTime(0.2, audioContext.currentTime);
      eerieLFOGain.gain.setValueAtTime(200, audioContext.currentTime);
      
      eerieLFO.connect(eerieLFOGain);
      eerieLFOGain.connect(eerie.frequency);
      
      eerie.connect(eerieFilter);
      eerieFilter.connect(eerieGain);
      eerieGain.connect(audioContext.destination);
      
      nodes.push({ osc: eerie }, { osc: eerieLFO });

      // 4. ‰ΩéÈ†ªËÑàË°ùÔºàÂøÉË∑≥ÊÑüÔºâ
      const pulse = audioContext.createOscillator();
      const pulseGain = audioContext.createGain();
      
      pulse.type = 'sine';
      pulse.frequency.setValueAtTime(110, audioContext.currentTime);
      
      pulseGain.gain.setValueAtTime(0, audioContext.currentTime);
      
      // ÂâµÂª∫ÂøÉË∑≥ÁØÄÂ•è
      const now = audioContext.currentTime;
      for (let i = 0; i < 100; i++) {
        const time = now + i * 2; // ÊØè2Áßí‰∏ÄÊ¨°
        pulseGain.gain.setValueAtTime(0, time);
        pulseGain.gain.linearRampToValueAtTime(0.15, time + 0.1);
        pulseGain.gain.linearRampToValueAtTime(0, time + 0.3);
        pulseGain.gain.setValueAtTime(0, time + 0.4);
        pulseGain.gain.linearRampToValueAtTime(0.12, time + 0.5);
        pulseGain.gain.linearRampToValueAtTime(0, time + 0.7);
      }
      
      pulse.connect(pulseGain);
      pulseGain.connect(audioContext.destination);
      
      nodes.push({ osc: pulse });

      // 5. ÁôΩÂô™Èü≥ÔºàÂÉèÊòØËÄÅËàäÊî∂Èü≥Ê©üÁöÑÈõúË®äÔºâ
      const bufferSize = 2 * audioContext.sampleRate;
      const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      const whiteNoise = audioContext.createBufferSource();
      whiteNoise.buffer = noiseBuffer;
      whiteNoise.loop = true;
      
      const noiseFilter = audioContext.createBiquadFilter();
      noiseFilter.type = 'lowpass';
      noiseFilter.frequency.setValueAtTime(200, audioContext.currentTime);
      
      const noiseGain = audioContext.createGain();
      noiseGain.gain.setValueAtTime(0.01, audioContext.currentTime);
      
      whiteNoise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(audioContext.destination);
      
      nodes.push({ osc: whiteNoise });

      // ÂïüÂãïÊâÄÊúâÈü≥Êïà
      nodes.forEach(node => node.osc.start());
      
      console.log('üéÉ Ëê¨ËÅñÁØÄÈü≥ÊïàÂ±§Ê¨°Ôºö‰ΩéÈü≥Âü∫Â∫ï + È¢®ËÅ≤ + Ë©≠Áï∞È´òÈü≥ + ÂøÉË∑≥ + ÁôΩÂô™Èü≥');
      
      return nodes;
    }

    function stopSpookyAmbience() {
      if (bgMusicOscillator) {
        try {
          bgMusicOscillator.forEach(node => {
            try {
              node.osc.stop();
            } catch (e) {
              // Â∑≤Á∂ìÂÅúÊ≠¢
            }
          });
        } catch (e) {
          console.log('Èü≥Ê®ÇÂ∑≤ÂÅúÊ≠¢');
        }
        bgMusicOscillator = null;
      }
    }

    musicControlEl.addEventListener('click', () => {
      if (isMusicPlaying) {
        stopSpookyAmbience();
        musicControlEl.classList.add('muted');
        musicTextEl.textContent = 'Â∑≤ÈùúÈü≥';
        isMusicPlaying = false;
        console.log('üîá Èü≥Ê®ÇÂ∑≤Êö´ÂÅú');
      } else {
        try {
          bgMusicOscillator = createSpookyAmbience();
          musicControlEl.classList.remove('muted');
          musicTextEl.textContent = 'Êí≠Êîæ‰∏≠';
          isMusicPlaying = true;
          console.log('ÔøΩ Ëê¨ËÅñÁØÄÊ∞õÂúçÈü≥ÊïàÊí≠Êîæ‰∏≠');
        } catch (err) {
          console.error('‚ùå Èü≥Ê®ÇÊí≠ÊîæÂ§±Êïó:', err);
          musicTextEl.textContent = 'Êí≠ÊîæÂ§±Êïó';
          alert('Èü≥Ê®ÇÊí≠ÊîæÂ§±Êïó: ' + err.message);
        }
      }
    });
    
    // YouTube Êí≠ÊîæÂô®È°ØÁ§∫/Èö±ËóèÂàáÊèõ
    youtubeToggleEl.addEventListener('click', () => {
      isYoutubeVisible = !isYoutubeVisible;
      if (isYoutubeVisible) {
        youtubePlayerEl.classList.remove('hidden');
      } else {
        youtubePlayerEl.classList.add('hidden');
      }
    });
    
    console.log('üéµ Èü≥Ê®ÇÁ≥ªÁµ±Â∑≤ÂàùÂßãÂåñÔºàWeb Audio API + YouTubeÔºâÔºåË´ãÈªûÊìäÂè≥‰∏äËßíÊåâÈàïÊí≠Êîæ');

    // ========== ÂïüÂãï ==========
    initMaze();
    initGhosts();
    initTreasures();
    connectWebSocket();
  </script>
</body>
</html>
