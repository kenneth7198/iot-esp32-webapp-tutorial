<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé® ÁîüÊàêËóùË°ì - Ëß∏Êéß‰∫íÂãï</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 40px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }

    .title {
      font-size: 24px;
      font-weight: 300;
      letter-spacing: 3px;
      color: #2c3e50;
    }

    .status-bar {
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 12px;
      color: #7f8c8d;
    }

    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e74c3c;
      transition: background 0.3s;
    }

    .connection-dot.connected {
      background: #2ecc71;
    }

    .canvas-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #artCanvas {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .controls {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 30px;
      border-radius: 50px;
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .control-btn {
      background: none;
      border: 2px solid #3498db;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #3498db;
    }

    .control-btn:hover {
      background: #3498db;
      color: white;
    }

    .control-btn.active {
      background: #2ecc71;
      border-color: #2ecc71;
      color: white;
    }

    .info-panel {
      position: fixed;
      top: 100px;
      right: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      font-size: 12px;
      color: #7f8c8d;
    }

    .info-title {
      font-size: 14px;
      color: #2c3e50;
      margin-bottom: 15px;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .info-item {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
    }

    .info-label {
      opacity: 0.7;
    }

    .info-value {
      font-weight: bold;
      color: #3498db;
    }

    .button-indicator {
      position: fixed;
      top: 50%;
      left: 30px;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 50%;
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
      transition: all 0.3s;
    }

    .button-indicator.pressed {
      background: #3498db;
      box-shadow: 0 5px 50px rgba(52, 152, 219, 0.6);
      transform: translateY(-50%) scale(1.2);
    }

    .button-icon {
      font-size: 48px;
      transition: all 0.3s;
    }

    .button-indicator.pressed .button-icon {
      filter: brightness(0) invert(1);
    }

    @keyframes ripple {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    .ripple {
      position: absolute;
      border: 3px solid #3498db;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      animation: ripple 1s ease-out;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- È†ÇÈÉ®Ê®ôÈ°åÂàó -->
  <div class="header">
    <div class="title">GENERATIVE ART ¬∑ ÁîüÊàêËóùË°ì</div>
    <div class="status-bar">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">ÈÄ£Êé•‰∏≠...</span>
    </div>
  </div>

  <!-- Áï´Â∏ÉÂÆπÂô® -->
  <div class="canvas-container">
    <canvas id="artCanvas"></canvas>
  </div>

  <!-- ÊåâÈàïÁãÄÊÖãÊåáÁ§∫Âô® -->
  <div class="button-indicator" id="buttonIndicator">
    <div class="button-icon">‚ö°</div>
  </div>

  <!-- Ë≥áË®äÈù¢Êùø -->
  <div class="info-panel">
    <div class="info-title">SYSTEM INFO</div>
    <div class="info-item">
      <span class="info-label">Pattern:</span>
      <span class="info-value" id="patternName">Flow Field</span>
    </div>
    <div class="info-item">
      <span class="info-label">Elements:</span>
      <span class="info-value" id="elementCount">0</span>
    </div>
    <div class="info-item">
      <span class="info-label">Button:</span>
      <span class="info-value" id="buttonStatus">Released</span>
    </div>
    <div class="info-item">
      <span class="info-label">FPS:</span>
      <span class="info-value" id="fpsCounter">60</span>
    </div>
  </div>

  <!-- ÊéßÂà∂Èù¢Êùø -->
  <div class="controls">
    <button class="control-btn active" data-pattern="flow">Flow Field</button>
    <button class="control-btn" data-pattern="particle">Particle System</button>
    <button class="control-btn" data-pattern="wave">Wave Pattern</button>
    <button class="control-btn" data-pattern="spiral">Spiral</button>
    <button class="control-btn" id="clearBtn">Clear</button>
  </div>

  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <script>
    // ========== Ë®≠ÂÆö ==========
    const WS_URL = 'ws://192.168.100.200:8080';
    const DEVICE_ID = 'esp32-art-01';

    // ========== Canvas Ë®≠ÂÆö ==========
    const canvas = document.getElementById('artCanvas');
    const ctx = canvas.getContext('2d');
    let width = window.innerWidth - 100;
    let height = window.innerHeight - 200;
    canvas.width = width;
    canvas.height = height;

    // ========== DOM ÂÖÉÁ¥† ==========
    const connectionDotEl = document.getElementById('connectionDot');
    const connectionTextEl = document.getElementById('connectionText');
    const buttonIndicatorEl = document.getElementById('buttonIndicator');
    const patternNameEl = document.getElementById('patternName');
    const elementCountEl = document.getElementById('elementCount');
    const buttonStatusEl = document.getElementById('buttonStatus');
    const fpsCounterEl = document.getElementById('fpsCounter');

    // ========== ÁãÄÊÖã ==========
    let ws = null;
    let isButtonPressed = false;
    let currentPattern = 'flow';
    let particles = [];
    let flowField = [];
    let time = 0;
    let lastFrameTime = Date.now();
    let fps = 60;

    // ========== Ëâ≤ÂΩ©ÊñπÊ°à ==========
    const colorSchemes = {
      pastel: ['#FFB6C1', '#B6E0FE', '#FFE4B5', '#D4A5A5', '#B5D4C3'],
      vibrant: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'],
      monochrome: ['#2C3E50', '#34495E', '#7F8C8D', '#95A5A6', '#BDC3C7'],
      sunset: ['#FF6B9D', '#C06C84', '#6C5B7B', '#355C7D', '#2A9D8F']
    };
    let currentColors = colorSchemes.pastel;

    // ========== Flow Field Á≤íÂ≠êÈ°û ==========
    class FlowParticle {
      constructor(x, y) {
        this.x = x || Math.random() * width;
        this.y = y || Math.random() * height;
        this.vx = 0;
        this.vy = 0;
        this.life = Math.random() * 100 + 100;
        this.maxLife = this.life;
        this.color = currentColors[Math.floor(Math.random() * currentColors.length)];
        this.size = Math.random() * 2 + 1;
      }

      update() {
        const angle = Math.sin(this.x * 0.01 + time) * Math.cos(this.y * 0.01 + time) * Math.PI * 2;
        this.vx = Math.cos(angle) * 0.5;
        this.vy = Math.sin(angle) * 0.5;
        
        this.x += this.vx;
        this.y += this.vy;
        this.life--;

        if (this.x < 0 || this.x > width || this.y < 0 || this.y > height || this.life <= 0) {
          this.reset();
        }
      }

      reset() {
        this.x = Math.random() * width;
        this.y = Math.random() * height;
        this.life = this.maxLife;
      }

      draw() {
        const alpha = this.life / this.maxLife;
        ctx.fillStyle = this.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // ========== Á≤íÂ≠êÁ≥ªÁµ±È°û ==========
    class ParticleSystem {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.particles = [];
        this.color = currentColors[Math.floor(Math.random() * currentColors.length)];
        
        for (let i = 0; i < 30; i++) {
          this.particles.push({
            x: this.x,
            y: this.y,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 0.5) * 8,
            life: 60,
            size: Math.random() * 4 + 2
          });
        }
      }

      update() {
        this.particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.2; // ÈáçÂäõ
          p.life--;
        });
        
        this.particles = this.particles.filter(p => p.life > 0);
      }

      draw() {
        this.particles.forEach(p => {
          const alpha = p.life / 60;
          ctx.fillStyle = this.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      isDead() {
        return this.particles.length === 0;
      }
    }

    // ========== ÂàùÂßãÂåñ ==========
    function init() {
      // Ê†πÊìöÊ®°ÂºèÂàùÂßãÂåñ
      switch (currentPattern) {
        case 'flow':
          particles = [];
          for (let i = 0; i < 500; i++) {
            particles.push(new FlowParticle());
          }
          break;
        case 'particle':
        case 'wave':
        case 'spiral':
          particles = [];
          break;
      }
    }

    // ========== ÂãïÁï´Âæ™Áí∞ ==========
    function animate() {
      requestAnimationFrame(animate);
      
      // Ë®àÁÆó FPS
      const now = Date.now();
      fps = Math.round(1000 / (now - lastFrameTime));
      lastFrameTime = now;
      fpsCounterEl.textContent = fps;
      
      // ÂçäÈÄèÊòéË¶ÜËìãÔºàÊãñÂ∞æÊïàÊûúÔºâ
      ctx.fillStyle = 'rgba(255, 255, 255, 0.03)';
      ctx.fillRect(0, 0, width, height);
      
      time += 0.01;
      
      // Ê†πÊìöÊ®°ÂºèÁπ™Ë£Ω
      switch (currentPattern) {
        case 'flow':
          particles.forEach(p => {
            p.update();
            p.draw();
          });
          break;
          
        case 'particle':
          particles.forEach((ps, index) => {
            ps.update();
            ps.draw();
            if (ps.isDead()) {
              particles.splice(index, 1);
            }
          });
          break;
          
        case 'wave':
          drawWavePattern();
          break;
          
        case 'spiral':
          drawSpiralPattern();
          break;
      }
      
      elementCountEl.textContent = particles.length;
    }

    // ========== Wave Pattern ==========
    function drawWavePattern() {
      ctx.strokeStyle = currentColors[Math.floor(time * 10) % currentColors.length] + '40';
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      for (let x = 0; x < width; x += 5) {
        const y = height / 2 + Math.sin(x * 0.01 + time * 2) * 100 * Math.cos(time);
        if (x === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      
      ctx.stroke();
    }

    // ========== Spiral Pattern ==========
    function drawSpiralPattern() {
      const centerX = width / 2;
      const centerY = height / 2;
      const arms = 5;
      
      ctx.strokeStyle = currentColors[Math.floor(time * 10) % currentColors.length] + '40';
      ctx.lineWidth = 2;
      
      for (let arm = 0; arm < arms; arm++) {
        ctx.beginPath();
        for (let i = 0; i < 200; i++) {
          const angle = (i * 0.1) + (arm * Math.PI * 2 / arms) + time;
          const radius = i * 2;
          const x = centerX + Math.cos(angle) * radius;
          const y = centerY + Math.sin(angle) * radius;
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();
      }
    }

    // ========== ÊåâÈàïËß∏ÁôºÊïàÊûú ==========
    function onButtonPress(x, y) {
      console.log('üé® ÊåâÈàïËß∏ÁôºËóùË°ìÊïàÊûú');
      
      switch (currentPattern) {
        case 'flow':
          // Ê∑ªÂä†Êñ∞ÁöÑÁ≤íÂ≠êÁæ§
          for (let i = 0; i < 50; i++) {
            particles.push(new FlowParticle(x, y));
          }
          break;
          
        case 'particle':
          // ÂâµÂª∫ÁàÜÁÇ∏ÊïàÊûú
          particles.push(new ParticleSystem(x, y));
          break;
          
        case 'wave':
        case 'spiral':
          // ÊîπËÆäÈ°èËâ≤ÊñπÊ°à
          const schemes = Object.keys(colorSchemes);
          const randomScheme = schemes[Math.floor(Math.random() * schemes.length)];
          currentColors = colorSchemes[randomScheme];
          break;
      }
      
      // Êº£Êº™ÊïàÊûú
      createRipple(x, y);
    }

    // ========== Êº£Êº™ÊïàÊûú ==========
    function createRipple(x, y) {
      const ripple = document.createElement('div');
      ripple.className = 'ripple';
      ripple.style.left = (x - 50) + 'px';
      ripple.style.top = (y - 50) + 'px';
      buttonIndicatorEl.appendChild(ripple);
      
      setTimeout(() => ripple.remove(), 1000);
    }

    // ========== WebSocket ÈÄ£Êé• ==========
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('‚úÖ WebSocket ÈÄ£Êé•ÊàêÂäü');
        connectionDotEl.classList.add('connected');
        connectionTextEl.textContent = 'Â∑≤ÈÄ£Êé•';
        
        // Ë®ÇÈñ±ÊåâÈàï‰∏ªÈ°å
        ws.send(JSON.stringify({
          type: 'subscribe',
          topic: `art/button/${DEVICE_ID}`
        }));
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.topic && data.topic.includes('art/button')) {
            const payload = JSON.parse(data.payload);
            handleButtonEvent(payload);
          }
        } catch (e) {
          console.error('Ëß£ÊûêË®äÊÅØÂ§±Êïó:', e);
        }
      };
      
      ws.onerror = (error) => {
        console.error('‚ùå WebSocket ÈåØË™§:', error);
        connectionTextEl.textContent = 'ÈÄ£Êé•ÈåØË™§';
      };
      
      ws.onclose = () => {
        console.log('üîå WebSocket Â∑≤Êñ∑ÈñãÔºå3 ÁßíÂæåÈáçÈÄ£...');
        connectionDotEl.classList.remove('connected');
        connectionTextEl.textContent = 'Â∑≤Êñ∑Èñã';
        setTimeout(connectWebSocket, 3000);
      };
    }

    // ========== ËôïÁêÜÊåâÈàï‰∫ã‰ª∂ ==========
    function handleButtonEvent(payload) {
      isButtonPressed = payload.pressed;
      
      if (isButtonPressed) {
        buttonIndicatorEl.classList.add('pressed');
        buttonStatusEl.textContent = 'Pressed';
        buttonStatusEl.style.color = '#e74c3c';
        
        // Âú®Èö®Ê©ü‰ΩçÁΩÆËß∏ÁôºÊïàÊûú
        const x = Math.random() * width;
        const y = Math.random() * height;
        onButtonPress(x, y);
      } else {
        buttonIndicatorEl.classList.remove('pressed');
        buttonStatusEl.textContent = 'Released';
        buttonStatusEl.style.color = '#3498db';
      }
    }

    // ========== ÊéßÂà∂ÊåâÈàï‰∫ã‰ª∂ ==========
    document.querySelectorAll('.control-btn[data-pattern]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.control-btn[data-pattern]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        currentPattern = btn.dataset.pattern;
        patternNameEl.textContent = btn.textContent;
        
        // Ê∏ÖÁ©∫Áï´Â∏É‰∏¶ÈáçÊñ∞ÂàùÂßãÂåñ
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);
        init();
      });
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      particles = [];
      init();
    });

    // ========== Ë¶ñÁ™óÂ§ßÂ∞èË™øÊï¥ ==========
    window.addEventListener('resize', () => {
      width = window.innerWidth - 100;
      height = window.innerHeight - 200;
      canvas.width = width;
      canvas.height = height;
      init();
    });

    // ========== ÊªëÈº†ÈªûÊìäËß∏ÁôºÔºàÊ∏¨Ë©¶Áî®Ôºâ ==========
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      onButtonPress(x, y);
    });

    // ========== ÂïüÂãï ==========
    init();
    animate();
    connectWebSocket();
    
    console.log('üé® ÁîüÊàêËóùË°ìÁ≥ªÁµ±Â∑≤ÂïüÂãï');
  </script>
</body>
</html>
