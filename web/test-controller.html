<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”§ æ§åˆ¶å™¨æ¸¬è©¦é é¢</title>
  <style>
    body {
      font-family: monospace;
      background: #000;
      color: #0f0;
      padding: 20px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    h1 {
      color: #ff6b00;
      text-align: center;
    }
    
    .test-section {
      background: #111;
      border: 2px solid #0f0;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .test-title {
      color: #ffaa00;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .success {
      color: #0f0;
    }
    
    .error {
      color: #f00;
    }
    
    .warning {
      color: #ffaa00;
    }
    
    button {
      background: #ff6b00;
      border: none;
      color: #000;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    
    button:active {
      background: #ffaa00;
    }
    
    #log {
      background: #000;
      border: 1px solid #333;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .log-entry {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ æ‰‹æ©Ÿæ§åˆ¶å™¨è¨ºæ–·å·¥å…·</h1>

  <div class="test-section">
    <div class="test-title">ğŸ“± åŸºæœ¬è³‡è¨Š</div>
    <div id="basicInfo"></div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸŒ ç¶²è·¯é€£æ¥æ¸¬è©¦</div>
    <div>
      <button onclick="testWebSocket()">æ¸¬è©¦ WebSocket</button>
      <button onclick="testHTTP()">æ¸¬è©¦ HTTP</button>
    </div>
    <div id="networkResult"></div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ“¡ æ„Ÿæ¸¬å™¨æ¸¬è©¦</div>
    <div>
      <button onclick="testMotion()">æ¸¬è©¦æ–å‹•åµæ¸¬</button>
      <button onclick="testOrientation()">æ¸¬è©¦æ–¹å‘æ„Ÿæ¸¬</button>
    </div>
    <div id="sensorResult"></div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ® æ§åˆ¶å™¨æ¸¬è©¦</div>
    <div>
      <button onclick="openController()">é–‹å•Ÿæ§åˆ¶å™¨</button>
      <button onclick="window.location.reload()">é‡æ–°è¼‰å…¥</button>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ“‹ å³æ™‚æ—¥èªŒ</div>
    <div id="log"></div>
  </div>

  <script>
    // ========== åŸºæœ¬è³‡è¨Š ==========
    function displayBasicInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      const deviceNumber = urlParams.get('device') || '01';
      const deviceId = `esp32-device-${deviceNumber}`;
      
      const info = `
        <div class="success">âœ… é é¢å·²è¼‰å…¥</div>
        <div>ğŸ†” Device ID: ${deviceId}</div>
        <div>ğŸ“± User Agent: ${navigator.userAgent}</div>
        <div>ğŸŒ URL: ${window.location.href}</div>
        <div>ğŸ”§ è¦–çª—å¤§å°: ${window.innerWidth} x ${window.innerHeight}</div>
      `;
      
      document.getElementById('basicInfo').innerHTML = info;
      addLog('âœ… åŸºæœ¬è³‡è¨Šè¼‰å…¥å®Œæˆ');
    }

    // ========== WebSocket æ¸¬è©¦ ==========
    async function testWebSocket() {
      addLog('ğŸ”„ é–‹å§‹æ¸¬è©¦ WebSocket...');
      const result = document.getElementById('networkResult');
      
      try {
        const ws = new WebSocket('ws://192.168.100.200:8080');
        
        ws.onopen = () => {
          result.innerHTML = '<div class="success">âœ… WebSocket é€£æ¥æˆåŠŸï¼</div>';
          addLog('âœ… WebSocket é€£æ¥æˆåŠŸ');
          ws.close();
        };
        
        ws.onerror = (error) => {
          result.innerHTML = `<div class="error">âŒ WebSocket é€£æ¥å¤±æ•—</div><div>éŒ¯èª¤: ${error}</div>`;
          addLog('âŒ WebSocket é€£æ¥å¤±æ•—');
        };
        
        ws.onclose = () => {
          addLog('ğŸ”Œ WebSocket å·²é—œé–‰');
        };
        
        setTimeout(() => {
          if (ws.readyState !== WebSocket.OPEN) {
            result.innerHTML = '<div class="error">âŒ WebSocket é€£æ¥é€¾æ™‚</div>';
            addLog('âŒ WebSocket é€£æ¥é€¾æ™‚');
            ws.close();
          }
        }, 5000);
        
      } catch (error) {
        result.innerHTML = `<div class="error">âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
        addLog(`âŒ éŒ¯èª¤: ${error.message}`);
      }
    }

    // ========== HTTP æ¸¬è©¦ ==========
    async function testHTTP() {
      addLog('ğŸ”„ é–‹å§‹æ¸¬è©¦ HTTP...');
      const result = document.getElementById('networkResult');
      
      try {
        const response = await fetch('http://192.168.100.200:8081/mobile-ghost-controller.html');
        
        if (response.ok) {
          result.innerHTML = `
            <div class="success">âœ… HTTP é€£æ¥æˆåŠŸï¼</div>
            <div>ç‹€æ…‹ç¢¼: ${response.status}</div>
            <div>Content-Type: ${response.headers.get('content-type')}</div>
          `;
          addLog('âœ… HTTP é€£æ¥æˆåŠŸ');
        } else {
          result.innerHTML = `<div class="error">âŒ HTTP éŒ¯èª¤: ${response.status}</div>`;
          addLog(`âŒ HTTP éŒ¯èª¤: ${response.status}`);
        }
      } catch (error) {
        result.innerHTML = `<div class="error">âŒ ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨: ${error.message}</div>`;
        addLog(`âŒ ç„¡æ³•é€£æ¥: ${error.message}`);
      }
    }

    // ========== æ–å‹•æ„Ÿæ¸¬å™¨æ¸¬è©¦ ==========
    function testMotion() {
      addLog('ğŸ”„ é–‹å§‹æ¸¬è©¦æ–å‹•æ„Ÿæ¸¬å™¨...');
      const result = document.getElementById('sensorResult');
      
      if (window.DeviceMotionEvent) {
        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ¬Šé™
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                startMotionTest(result);
              } else {
                result.innerHTML = '<div class="error">âŒ æ¬Šé™è¢«æ‹’çµ•</div>';
                addLog('âŒ å‹•ä½œæ„Ÿæ¸¬å™¨æ¬Šé™è¢«æ‹’çµ•');
              }
            })
            .catch(error => {
              result.innerHTML = `<div class="error">âŒ æ¬Šé™è«‹æ±‚å¤±æ•—: ${error}</div>`;
              addLog(`âŒ æ¬Šé™è«‹æ±‚å¤±æ•—: ${error}`);
            });
        } else {
          startMotionTest(result);
        }
      } else {
        result.innerHTML = '<div class="error">âŒ æ­¤è£ç½®ä¸æ”¯æ´å‹•ä½œæ„Ÿæ¸¬å™¨</div>';
        addLog('âŒ ä¸æ”¯æ´å‹•ä½œæ„Ÿæ¸¬å™¨');
      }
    }

    function startMotionTest(result) {
      result.innerHTML = '<div class="success">âœ… å‹•ä½œæ„Ÿæ¸¬å™¨å·²å•Ÿå‹•ï¼Œè«‹æ–å‹•æ‰‹æ©Ÿ...</div><div id="motionData"></div>';
      addLog('âœ… å‹•ä½œæ„Ÿæ¸¬å™¨å·²å•Ÿå‹•');
      
      let shakeCount = 0;
      const motionDataEl = document.getElementById('motionData');
      
      const handler = (event) => {
        const acc = event.accelerationIncludingGravity;
        const x = acc.x.toFixed(2);
        const y = acc.y.toFixed(2);
        const z = acc.z.toFixed(2);
        
        motionDataEl.innerHTML = `
          <div>X: ${x}</div>
          <div>Y: ${y}</div>
          <div>Z: ${z}</div>
          <div class="warning">æ–å‹•æ¬¡æ•¸: ${shakeCount}</div>
        `;
        
        if (Math.abs(acc.x) > 15) {
          shakeCount++;
          addLog(`ğŸ“³ åµæ¸¬åˆ°æ–å‹• (${shakeCount})`);
          if (navigator.vibrate) {
            navigator.vibrate(100);
          }
        }
      };
      
      window.addEventListener('devicemotion', handler);
      
      setTimeout(() => {
        window.removeEventListener('devicemotion', handler);
        result.innerHTML += '<div class="success">âœ… æ¸¬è©¦å®Œæˆ</div>';
        addLog('âœ… å‹•ä½œæ„Ÿæ¸¬å™¨æ¸¬è©¦å®Œæˆ');
      }, 10000);
    }

    // ========== æ–¹å‘æ„Ÿæ¸¬å™¨æ¸¬è©¦ ==========
    function testOrientation() {
      addLog('ğŸ”„ é–‹å§‹æ¸¬è©¦æ–¹å‘æ„Ÿæ¸¬å™¨...');
      const result = document.getElementById('sensorResult');
      
      if (window.DeviceOrientationEvent) {
        result.innerHTML = '<div class="success">âœ… æ–¹å‘æ„Ÿæ¸¬å™¨å·²å•Ÿå‹•</div><div id="orientationData"></div>';
        addLog('âœ… æ–¹å‘æ„Ÿæ¸¬å™¨å·²å•Ÿå‹•');
        
        const orientationDataEl = document.getElementById('orientationData');
        
        const handler = (event) => {
          orientationDataEl.innerHTML = `
            <div>Alpha: ${event.alpha?.toFixed(2) || 'N/A'}</div>
            <div>Beta: ${event.beta?.toFixed(2) || 'N/A'}</div>
            <div>Gamma: ${event.gamma?.toFixed(2) || 'N/A'}</div>
          `;
        };
        
        window.addEventListener('deviceorientation', handler);
        
        setTimeout(() => {
          window.removeEventListener('deviceorientation', handler);
          result.innerHTML += '<div class="success">âœ… æ¸¬è©¦å®Œæˆ</div>';
          addLog('âœ… æ–¹å‘æ„Ÿæ¸¬å™¨æ¸¬è©¦å®Œæˆ');
        }, 5000);
      } else {
        result.innerHTML = '<div class="error">âŒ æ­¤è£ç½®ä¸æ”¯æ´æ–¹å‘æ„Ÿæ¸¬å™¨</div>';
        addLog('âŒ ä¸æ”¯æ´æ–¹å‘æ„Ÿæ¸¬å™¨');
      }
    }

    // ========== é–‹å•Ÿæ§åˆ¶å™¨ ==========
    function openController() {
      const urlParams = new URLSearchParams(window.location.search);
      const device = urlParams.get('device') || '01';
      const url = `mobile-ghost-controller.html?device=${device}`;
      addLog(`ğŸ® é–‹å•Ÿæ§åˆ¶å™¨: ${url}`);
      window.location.href = url;
    }

    // ========== æ—¥èªŒç³»çµ± ==========
    function addLog(message) {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
      console.log(message);
    }

    // ========== åˆå§‹åŒ– ==========
    window.addEventListener('DOMContentLoaded', () => {
      addLog('ğŸš€ è¨ºæ–·å·¥å…·å•Ÿå‹•');
      displayBasicInfo();
    });

    window.addEventListener('error', (event) => {
      addLog(`âŒ JavaScript éŒ¯èª¤: ${event.message}`);
    });
  </script>
</body>
</html>
