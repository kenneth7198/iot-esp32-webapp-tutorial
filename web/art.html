<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IoT 藝術互動 - 色塊撈取</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    body { padding: 1rem; }
    .art-canvas { width: 320px; height: 320px; border:2px solid #888; margin:auto; display:block; }
    .picked { border: 3px solid #f00 !important; }
    .color-preview { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #333; margin: 1rem auto; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="mb-3">IoT 藝術互動：色塊撈取</h3>
  <svg id="art" class="art-canvas" viewBox="0 0 320 320">
    <rect x="10" y="10" width="90" height="90" fill="#e74c3c" data-color="#e74c3c"/>
    <rect x="110" y="10" width="90" height="90" fill="#3498db" data-color="#3498db"/>
    <rect x="210" y="10" width="90" height="90" fill="#f1c40f" data-color="#f1c40f"/>
    <rect x="10" y="110" width="90" height="90" fill="#2ecc71" data-color="#2ecc71"/>
    <rect x="110" y="110" width="90" height="90" fill="#9b59b6" data-color="#9b59b6"/>
    <rect x="210" y="110" width="90" height="90" fill="#34495e" data-color="#34495e"/>
    <rect x="60" y="220" width="200" height="80" fill="#fff" stroke="#aaa" stroke-width="2" data-color="#fff"/>
  </svg>
  <div class="color-preview" id="colorPreview"></div>
  <div class="text-center mb-2">目前選取顏色：<span id="colorText">無</span></div>
  <div class="mb-2">
    <label>WebSocket URL</label>
    <input id="wsUrl" class="form-control" value="ws://localhost:9001" />
  </div>
  <div class="mb-2">
    <label>裝置 ID</label>
    <input id="deviceId" class="form-control" value="esp32-01" />
  </div>
  <button id="btnConnect" class="btn btn-primary">Connect MQTT</button>
  <button id="btnDisconnect" class="btn btn-outline-secondary">Disconnect</button>
  <pre class="log mt-3" id="log" style="height:120px;background:#111;color:#0f0;font-family:monospace;padding:8px;"></pre>
</div>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
let client;
const log = (s) => { const el = document.getElementById('log'); el.textContent += s + '\n'; el.scrollTop = el.scrollHeight; }
const colorPreview = document.getElementById('colorPreview');
const colorText = document.getElementById('colorText');

// 點擊色塊撈取顏色
[...document.querySelectorAll('#art rect')].forEach(rect => {
  rect.addEventListener('click', function() {
    document.querySelectorAll('#art rect').forEach(r => r.classList.remove('picked'));
    rect.classList.add('picked');
    const color = rect.getAttribute('data-color');
    colorPreview.style.background = color;
    colorText.textContent = color;
    sendColor(color);
  });
});

function sendColor(color) {
  if (!client || !client.connected) return;
  const dev = document.getElementById('deviceId').value.trim();
  const topic = `iot/lab/${dev}/cmd/color`;
  const payload = JSON.stringify({ cmd: 'color', value: color, ts: Date.now() });
  client.publish(topic, payload, { qos: 1 });
  log(`[PUB] ${topic} : ${payload}`);
}

document.getElementById('btnConnect').onclick = () => {
  const url = document.getElementById('wsUrl').value.trim();
  client = mqtt.connect(url);
  client.on('connect', () => log('[WS] connected'));
  client.on('reconnect', () => log('[WS] reconnect'));
  client.on('error', (e) => log('[WS] error: ' + e.message));
  client.on('message', (t, p) => log(`[MSG] ${t} : ${p}`));
};
document.getElementById('btnDisconnect').onclick = () => { if (client) client.end(); };
</script>
</body>
</html>